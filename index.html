<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Professional LED Configuration Calculator</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <style>
    /* Base styles */
    body { font-family: 'Inter', sans-serif; margin: 0; padding: 40px; background: #f7f9fc; color: #333; font-size: 14px; }
    .container { background: #ffffff; max-width: 600px; margin: auto; padding: 30px 40px; border-radius: 16px; box-shadow: 0 8px 30px rgba(0,0,0,0.1); color: #212121; overflow: hidden; margin-bottom: 30px; transition: all 0.6s ease-out; height: auto; max-height: 1000px; opacity: 1; }
    .container.minimized { height: 115px; padding-top: 15px; padding-bottom: 10px; opacity: 0.9; overflow: hidden; background: #eef2f8; }
    .container.minimized > *:not(h2):not(#enteredValuesDisplay):not(.back-btn-placeholder) { opacity: 0; max-height: 0; overflow: hidden; transition: opacity 0.3s ease-out, max-height 0.3s ease-out; pointer-events: none; }
    .container.minimized h2 { margin-bottom: 5px; }
    #enteredValuesDisplay { text-align: center; font-size: 0.95em; color: #444; margin-bottom: 15px; line-height: 1.4; display: none; }
    .container.minimized #enteredValuesDisplay { display: block !important; opacity: 1; transition: opacity 0.3s ease-out 0.3s; }
    h2 { text-align: center; color: #0D47A1; margin-top: 0; margin-bottom: 20px; transition: margin 0.6s ease-out; }
    label { display: block; margin-top: 15px; font-weight: 600; color: #1B5E20; }
    select, input[type="number"] { width: 100%; padding: 10px; margin-top: 5px; font-size: 14px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
    .submit-btn, .back-btn { margin-top: 30px; background-color: #0D47A1; color: white; padding: 12px; border: none; border-radius: 6px; font-size: 16px; width: 100%; cursor: pointer; transition: background-color 0.3s; }
    .submit-btn:hover { background-color: #1565C0; }
    .back-btn { background-color: #6c757d; margin-top: 20px; }
    .back-btn:hover { background-color: #5a6268; }
    .hidden { display: none !important; }
    .error-message { color: #B71C1C; font-weight: bold; text-align: center; margin-top: 15px; padding: 5px; min-height: 20px; }
    .visualization { background: #fff; max-width: 800px; margin: 0 auto; padding: 30px; border-radius: 16px; box-shadow: 0 8px 30px rgba(0,0,0,0.15); opacity: 0; max-height: 0; overflow-y: auto; transition: opacity 0.6s ease-out, max-height 1s ease-out; }
    .visualization.visible { opacity: 1; max-height: 90vh; }
    .vis-content { position: relative; width: 100%; margin-bottom: 20px; min-height: 150px; padding-top: 35px; padding-right: 45px; padding-bottom: 10px; box-sizing: border-box; }
    .grid { position: relative; width: 100%; border: 2px solid #0D47A1; min-height: 100px; overflow: hidden; background: linear-gradient(135deg, #e0f2f1, #b2dfdb); }
    #cabinetOverlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; box-sizing: border-box; pointer-events: none; z-index: 5; }
    .dimension-label { position: absolute; color: #0D47A1; background: rgba(255, 255, 255, 0.95); padding: 3px 6px; font-size: 0.9em; border-radius: 3px; font-weight: 600; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .dim-top { top: 5px; left: 50%; transform: translateX(-50%); }
    .dim-right { top: 50%; right: 10px; transform: translateY(-50%) rotate(90deg); transform-origin: center center; }
    .vis-details { margin-top: 20px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px 25px; font-size: 0.95em; color: #333; }
    .vis-details span { display: block; line-height: 1.4; }
    .vis-details strong { color: #0D47A1; font-weight: 600; }
    .vis-details small { font-size: 0.85em; color: #555; }
    #downloadPdfLink { grid-column: 1 / -1; margin-top: 15px; text-align: center; cursor: pointer; color: #1B5E20; text-decoration: underline; padding: 8px 0; font-weight: 600; }
    #downloadPdfLink:hover { color: #2E7D32; }
    /* Styles for the click-to-show controller name */
    #suggestedController strong { cursor: pointer; text-decoration: underline dotted; text-decoration-color: #aaa; }
    #suggestedController strong:hover { color: #1565C0; }
  </style>
</head>
<body>
  <div class="container" id="formContainer">
    <h2>LED Video Wall Configuration Tool</h2>
    <div id="enteredValuesDisplay" class="hidden">
        <span id="enteredSummaryText"></span><br>
        Aspect Ratio: <strong><span id="aspectRatioValue">--</span></strong>
    </div>
    <div id="errorMessage" class="error-message hidden"></div>

    <label for="productModel">LED Model / Pixel Pitch</label>
    <select id="productModel">
        <option value="viewsonicLDC091C">ViewSonic LDC027G-091C (0.9375mm) - Recommended</option>
        <option value="smd_125">PeopleLink/Generic SMD (1.25mm)</option>
        <option value="smd_154">PeopleLink/Generic SMD (1.54mm)</option>
        <option value="smd_25">PeopleLink/Generic Outdoor (2.5mm)</option>
    </select>
    
    <label for="unit">Unit of Measurement</label>
    <select id="unit" onchange="toggleMeasurementFields()"> 
        <option value="">Select unit</option> 
        <option value="meters">Meters (m)</option> 
        <option value="feet">Feet (ft)</option> 
        <option value="inches">Inches (in) - Diagonal</option> 
    </select>
    
    <label for="width" id="widthLabel">Desired Width (X)</label>
    <input type="number" id="width" placeholder="Enter desired width" min="0.1" step="0.01">
    
    <label for="height" id="heightLabel">Desired Height (Y)</label>
    <input type="number" id="height" placeholder="Enter desired height" min="0.1" step="0.01">
    
    <label for="diagonal" id="diagonalLabel" class="hidden">Desired Diagonal (Z)</label>
    <input type="number" id="diagonal" placeholder="Enter desired diagonal inches" min="10" step="1" class="hidden">
    
    <label for="aspectRatio" id="aspectRatioLabel" class="hidden">Aspect Ratio</label>
    <select id="aspectRatio" class="hidden"> 
        <option value="">Select ratio</option> 
        <option value="16:9">16:9 (HD/UHD)</option> 
        <option value="16:10">16:10 (WUXGA)</option> 
        <option value="4:3">4:3 (Legacy)</option> 
        <option value="1:1">1:1 (Square)</option> 
    </select>
    
    <button class="submit-btn" id="submitButton" onclick="showVisualization()">Calculate & Visualize</button>
    <div class="back-btn-placeholder hidden"></div>
  </div>

  <div class="visualization" id="visualization">
    <div class="vis-content">
       <div class="grid" id="visGrid">
           <div id="cabinetOverlay"></div>
           <span class="dimension-label dim-top" id="visWidthLabel">-- W --</span>
           <span class="dimension-label dim-right" id="visHeightLabel">-- H --</span>
       </div>
    </div>
    
    <div class="vis-details">
      <span id="productName">Product Model: <strong>--</strong></span>
      <span id="pixelPitchDisplay">Pixel Pitch: <strong>--</strong></span>
      <span id="cabinetSize">Cabinet Size: <strong>--</strong></span>
      <span id="numCabinets">Total Cabinets (WxH): <strong>--</strong></span>
      <span id="finalDimensions">Actual Final Dimensions (WxH): <strong>--</strong></span>
      <span id="finalDiagonal">Final Diagonal Size: <strong>--</strong></span>
      <span id="resolution">Actual Final Resolution (WxH): <strong>--</strong></span>
      <span id="totalPixels">Total Pixels: <strong>--</strong></span>
      <span id="moduleSize">Module Size: <strong>--</strong></span>
      <span id="numModules">Total Modules (WxH): <strong>--</strong></span>
      <span id="finalArea">Final Area: <strong>--</strong></span>
      <span id="requiredPorts">Required Sending Ports: <strong>--</strong></span>
      <span id="suggestedController" data-controller-name="">Suggested Controller (Novastar/VNNox): <strong>--</strong></span>
      <span id="vendorController">Vendor Control Box: <strong>--</strong></span>
      <span id="downloadPdfLink" onclick="downloadPdf()">Download PDF Technical Summary ðŸ“„</span>
    </div>

     <button class="back-btn" id="backButton" onclick="hideVisualization()">Modify Configuration</button>
  </div>

  <div id="popupOverlay" class="hidden"></div>
  <div id="controllerInfoPopup" class="hidden">
      <button id="popupCloseBtn" onclick="hidePopup()">Ã—</button>
      <h3 id="popupTitle">Controller Details</h3>
      <div id="popupContent"></div>
  </div>

  <script>
    // --- Constants ---
    const MM_PER_METER = 1000;
    const MM_PER_INCH = 25.4;
    const MM_PER_FOOT = MM_PER_INCH * 12;
    const PIXELS_PER_SENDING_PORT = 650000; // Typical max resolution per standard Novastar/VNNox port
    const SENDING_CARD_PORTS = 16;
    const ALT_SENDING_CARD_PORTS = 20;

    // Novastar/VNNox Card Names
    const DEFAULT_H_SENDING_CARD = "H_16xRJ45+2xFiber";
    const DEFAULT_H_PREVIEW_CARD = "H_2xRJ45+1xHDMI1.3";
    const H_INPUT_CARD = "H_1xHDMI2.0";
    const ALT_H_SENDING_CARD = "H_20xRJ45";
    const MULTIFUNCTION_CARD_NAME = 'MFK300';
    const MULTIFUNCTION_CARD_QTY = 1;
    
    // --- Data Store (Incorporating ViewSonic LDC027G-091C from PDF) ---
    const LED_PRODUCTS = {
        'viewsonicLDC091C': {
            name: "ViewSonic LDC027G-091C (0.9375mm)",
            pitch_mm: 0.9375,
            cabW_mm: 600,
            cabH_mm: 337.5,
            modW_mm: 150,
            modH_mm: 168.75,
            cabModW: 4, // 600/150 = 4 modules wide
            cabModH: 2, // 337.5/168.75 = 2 modules high
            cabPixW: 640, // (600 / 0.9375) = 640 pixels wide
            cabPixH: 360, // (337.5 / 0.9375) = 360 pixels high
            vendorController: "LD-SCB-024" // From uploaded PDF
        },
        'smd_125': {
            name: "PeopleLink/Generic SMD (1.25mm)",
            pitch_mm: 1.25,
            cabW_mm: 640,
            cabH_mm: 480,
            modW_mm: 320,
            modH_mm: 160,
            cabModW: 2,
            cabModH: 3,
            cabPixW: 512,
            cabPixH: 384,
            vendorController: null
        },
        'smd_154': {
            name: "PeopleLink/Generic SMD (1.54mm)",
            pitch_mm: 1.5385,
            cabW_mm: 640,
            cabH_mm: 480,
            modW_mm: 320,
            modH_mm: 160,
            cabModW: 2,
            cabModH: 3,
            cabPixW: 416,
            cabPixH: 312,
            vendorController: null
        },
        'smd_25': {
            name: "PeopleLink/Generic Outdoor (2.5mm)",
            pitch_mm: 2.5,
            cabW_mm: 960,
            cabH_mm: 960,
            modW_mm: 320,
            modH_mm: 160,
            cabModW: 3,
            cabModH: 6,
            cabPixW: 384,
            cabPixH: 384,
            vendorController: null
        }
    };

    // Controller data for Novastar/VNNox systems (Sorted by max pixels)
    const controllers=[
        {name:"TB40",maxPixels:1300000,sendingPorts:2,outputCardSlots:0, isHSeries:!1,details:"2x Main Eth Outputs (1 Backup). Android OS."},
        {name:"TB60",maxPixels:2300000,sendingPorts:4,outputCardSlots:0, isHSeries:!1,details:"4x Main Eth Outputs. Android OS."},
        {name:"VX400 Pro",maxPixels:2600000,sendingPorts:4,outputCardSlots:0, isHSeries:!1,details:"4x Eth Outputs. Inputs: 3G-SDI, HDMI 1.3, DVI."},
        {name:"VX600 Pro",maxPixels:3900000,sendingPorts:6,outputCardSlots:0, isHSeries:!1,details:"6x Eth Outputs. Inputs: 3G-SDI, HDMI 1.3, DVI. Layers: 1 Main + 2 PIP."},
        {name:"VX1000 Pro",maxPixels:6500000,sendingPorts:10,outputCardSlots:0, isHSeries:!1,details:"10x Eth Outputs. Inputs: 3G-SDI, HDMI 1.4, DVI(HDMI 1.4). Layers: 1 Main + 2 PIP."},
        {name:"4K-Prime",maxPixels:10000000,sendingPorts:16,outputCardSlots:0, isHSeries:!1,details:"16x Eth + 4x OPT Outputs. Inputs: DP 1.2, HDMI 2.0, DVI(4). DVI Mosaic. HDR. 10-bit."},
        {name:"H2",maxPixels:26000000,sendingPorts:40,outputCardSlots:2, isHSeries:!0,details:"Modular (2U Rack). Max 2 Output cards."},
        {name:"H5",maxPixels:39000000,sendingPorts:60,outputCardSlots:3, isHSeries:!0,details:"Modular (5U Rack). Max 3 Output cards."},
    ].sort((a,b)=>a.maxPixels-b.maxPixels);

    const TERMS_AND_CONDITIONS=["Warranty 1 Year","Required Fibber or CAT6 Cables (as per the drawing) to be laid by Client or SI.","Required Uninterrupted Power Cables/Points/Distribution Box (as per the drawing) is in Client's or SI's Scope.","Scaffolding or Man Lift, if required at the site, will be under SI/Client's Scope","Any cladding(Covering of sides of the screen) if required will be under SI/Clientâ€™s Scope","Any integration of third-party product will be under Client's/SI's Scope","Rack for Controller under SI's Scope.","Require Flat Surface for Installation of LED Wall along with fabrication as per the design shared by our team.","Content for the above Configuration with respect to the Aspect Ratio and Resolution shall be under Client's/SI's Scope.","Mounting Structure and Enclosure will be charged extra as per Site Conditions/Scope of Work.","Installation & Configuration under Client/SI Scope.","Plywood of appropriate (15-18mm) dimension need to be placed on iron frame before placing/fixing the Cabinets, will be under Client's/SI's Scope"];


    // --- Global Store and Helpers ---
    let finalCalculationData = {}; 

    function formatNumber(n,d=1){return n.toLocaleString(undefined,{minimumFractionDigits:d,maximumFractionDigits:d});}
    function formatLargeNumber(n){if(n>=1e6)return(n/1e6).toFixed(2)+"M";if(n>=1e3)return(n/1e3).toFixed(1)+"K";return n.toLocaleString();}
    function gcd(a,b){return b===0?a:gcd(b,a%b);}
    function getTimestamp(){const n=new Date();const d=n.toLocaleDateString();const t=n.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit',hour12:!0});return`${d} ${t}`;}


    // --- Core Functions ---
    function toggleMeasurementFields(){
        const u=document.getElementById('unit').value;
        const s=(u==='inches');
        document.getElementById('width').classList.toggle('hidden',s);
        document.getElementById('height').classList.toggle('hidden',s);
        document.getElementById('widthLabel').classList.toggle('hidden',s);
        document.getElementById('heightLabel').classList.toggle('hidden',s);
        document.getElementById('diagonal').classList.toggle('hidden',!s);
        document.getElementById('diagonalLabel').classList.toggle('hidden',!s);
        document.getElementById('aspectRatio').classList.toggle('hidden',!s);
        document.getElementById('aspectRatioLabel').classList.toggle('hidden',!s);

        if (s) {
            document.getElementById('width').value = '';
            document.getElementById('height').value = '';
        } else {
            document.getElementById('diagonal').value = '';
            document.getElementById('aspectRatio').value = '';
        }
        document.getElementById('errorMessage').classList.add('hidden');
    }

    function calculateLEDWall(){
        // 1. Get User Input
        const productKey = document.getElementById('productModel').value;
        const unit = document.getElementById('unit').value;
        let inputW = parseFloat(document.getElementById('width').value);
        let inputH = parseFloat(document.getElementById('height').value);
        let inputD = parseFloat(document.getElementById('diagonal').value);
        const aspectRatioKey = document.getElementById('aspectRatio').value;

        const errorDiv=document.getElementById('errorMessage');
        errorDiv.classList.add('hidden');
        if (!productKey || !unit) {
            errorDiv.textContent = 'Please select an LED Model/Pitch and Unit.';
            errorDiv.classList.remove('hidden');
            return null;
        }

        const isDiagonal = (unit === 'inches');
        if (!isDiagonal && (!inputW || !inputH || inputW <= 0 || inputH <= 0)) {
            errorDiv.textContent = 'Please enter valid positive Width and Height values.';
            errorDiv.classList.remove('hidden');
            return null;
        }

        if (isDiagonal && (!inputD || !aspectRatioKey || inputD <= 0)) {
            errorDiv.textContent = 'Please enter a valid positive Diagonal and select an Aspect Ratio.';
            errorDiv.classList.remove('hidden');
            return null;
        }

        const details = LED_PRODUCTS[productKey];
        if (!details) {
            errorDiv.textContent = 'Invalid LED product data.';
            errorDiv.classList.remove('hidden');
            return null;
        }

        const cabinetW_mm = details.cabW_mm;
        const cabinetH_mm = details.cabH_mm;
        
        // 2. Convert input to millimeters (Desired dimensions)
        let desiredW_mm, desiredH_mm;
        if (unit === 'meters') {
            desiredW_mm = inputW * MM_PER_METER;
            desiredH_mm = inputH * MM_PER_METER;
        } else if (unit === 'feet') {
            desiredW_mm = inputW * MM_PER_FOOT;
            desiredH_mm = inputH * MM_PER_FOOT;
        } else if (unit === 'inches') {
            const [ratioW, ratioH] = aspectRatioKey.split(':').map(Number);
            const ratioDiagonal = Math.sqrt(ratioW * ratioW + ratioH * ratioH);
            const factor = inputD / ratioDiagonal;

            desiredW_mm = ratioW * factor * MM_PER_INCH;
            desiredH_mm = ratioH * factor * MM_PER_INCH;
        }

        // 3. Calculate cabinets needed (round up to ensure desired area is covered)
        let numCabW = Math.ceil(desiredW_mm / cabinetW_mm);
        let numCabH = Math.ceil(desiredH_mm / cabinetH_mm);
        
        // Ensure minimum 1x1 cabinet if inputs were too small
        numCabW = Math.max(1, numCabW);
        numCabH = Math.max(1, numCabH);


        // 4. Calculate Final Actual Dimensions (in mm)
        const finalW_mm = numCabW * cabinetW_mm;
        const finalH_mm = numCabH * cabinetH_mm;

        // 5. Calculate Pixel Resolution
        const finalResW = numCabW * details.cabPixW;
        const finalResH = numCabH * details.cabPixH;
        const totalPixels = finalResW * finalResH;

        // 6. Calculate Aspect Ratio and Diagonal
        const ratioGCD = gcd(finalResW, finalResH);
        const aspectRatioText = `${finalResW / ratioGCD}:${finalResH / ratioGCD}`;
        const finalDiagonal_mm = Math.sqrt(finalW_mm * finalW_mm + finalH_mm * finalH_mm);
        const finalDiagonal_in = finalDiagonal_mm / MM_PER_INCH;

        // 7. Calculate Controller Requirements
        const reqPorts = Math.ceil(totalPixels / PIXELS_PER_SENDING_PORT);
        let suggestedController = controllers.find(c => c.maxPixels >= totalPixels);
        if (!suggestedController) {
            suggestedController = { name: "None sufficient", maxPixels: Infinity, details: "Exceeds all listed Novastar/VNNox controller capabilities." };
        }

        // Store data
        return {
            productName: details.name,
            unit: unit,
            desiredW_mm: desiredW_mm,
            desiredH_mm: desiredH_mm,
            numCabW: numCabW,
            numCabH: numCabH,
            finalW_mm: finalW_mm,
            finalH_mm: finalH_mm,
            finalResW: finalResW,
