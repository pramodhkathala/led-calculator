<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PeopleLink LED Video Wall Configuration Calculator</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <style>
    /* Base styles */
    body { font-family: 'Inter', sans-serif; margin: 0; padding: 40px; background: #eef1f8; color: #1c2738; font-size: 14px; }
    .main-wrapper { max-width: 1200px; margin: auto; }
    
    /* Header & Titles */
    h2 { text-align: center; color: #0D47A1; margin-top: 0; margin-bottom: 30px; font-weight: 700; font-size: 1.8em; }

    /* Input/Form Container */
    .input-panel { background: #ffffff; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); transition: all 0.6s ease-out; }
    .input-panel.minimized { height: 120px; padding-top: 15px; padding-bottom: 10px; opacity: 0.9; overflow: hidden; background: #f7f9fc; }
    .input-panel.minimized > *:not(h2):not(#enteredValuesDisplay):not(.back-btn-placeholder) { opacity: 0; max-height: 0; overflow: hidden; transition: opacity 0.3s ease-out, max-height 0.3s ease-out; pointer-events: none; }
    .input-panel.minimized h2 { margin-bottom: 5px; }
    
    .input-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px 30px; }
    .input-group { margin-top: 0; }
    
    label { display: block; margin-bottom: 5px; font-weight: 600; color: #444; }
    select, input[type="number"], input[type="text"] { 
        width: 100%; padding: 10px 12px; font-size: 15px; border: 1px solid #dcdcdc; border-radius: 6px; box-sizing: border-box; transition: border-color 0.3s, box-shadow 0.3s; 
    }
    select:focus, input[type="number"]:focus, input[type="text"]:focus { border-color: #0D47A1; box-shadow: 0 0 0 2px rgba(13, 71, 161, 0.2); outline: none; }
    
    /* Buttons */
    .submit-btn { margin-top: 25px; grid-column: 1 / -1; background-color: #0D47A1; color: white; padding: 14px; border: none; border-radius: 8px; font-size: 16px; width: 100%; cursor: pointer; transition: background-color 0.3s, transform 0.2s; font-weight: 600; }
    .submit-btn:hover { background-color: #1565C0; transform: translateY(-1px); }
    .back-btn { background-color: #6c757d; margin-top: 30px; }
    .back-btn:hover { background-color: #5a6268; }
    
    /* Error/Summary Display - ENHANCED VISIBILITY */
    .hidden { display: none !important; }
    .error-message { 
        color: #B71C1C; 
        font-weight: bold; 
        text-align: center; 
        margin-top: 15px; 
        padding: 15px; 
        min-height: 20px; 
        background: #ffebee; 
        border: 2px solid #B71C1C; /* Added border for prominence */
        border-radius: 8px; 
        transition: all 0.3s ease;
    }
    #enteredValuesDisplay { text-align: center; font-size: 0.95em; color: #444; margin-bottom: 15px; line-height: 1.4; display: none; }
    .input-panel.minimized #enteredValuesDisplay { display: block !important; opacity: 1; transition: opacity 0.3s ease-out 0.3s; }

    /* Visualization/Output Container */
    .visualization { background: #ffffff; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); opacity: 0; max-height: 0; overflow-y: hidden; transition: opacity 0.6s ease-out, max-height 1s ease-out; margin-top: 30px; }
    .visualization.visible { opacity: 1; max-height: 2000px; } 
    
    .output-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 20px; }
    
    /* Visualization Area */
    .vis-box { border: 1px solid #e0e0e0; padding: 20px; border-radius: 8px; background: #f7f9fc; }
    .vis-content { position: relative; width: 100%; margin-bottom: 20px; padding-top: 35px; padding-right: 45px; padding-bottom: 10px; box-sizing: border-box; }
    .grid { position: relative; width: 100%; border: 3px solid #B71C1C; min-height: 100px; overflow: hidden; background: linear-gradient(135deg, #e3f2fd, #bbdefb); }
    #cabinetOverlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; box-sizing: border-box; pointer-events: none; z-index: 5; }
    .dimension-label { position: absolute; color: #B71C1C; background: rgba(255, 255, 255, 0.95); padding: 3px 6px; font-size: 0.9em; border-radius: 3px; font-weight: 700; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .dim-top { top: 5px; left: 50%; transform: translateX(-50%); }
    .dim-right { top: 50%; right: 10px; transform: translateY(-50%) rotate(90deg); transform-origin: center center; }

    /* Details Section */
    .details-box { border: 1px solid #e0e0e0; padding: 20px; border-radius: 8px; background: #f7f9fc; }
    .details-box h4 { margin-top: 0; color: #0D47A1; border-bottom: 2px solid #e0e0e0; padding-bottom: 8px; margin-bottom: 15px; font-size: 1.1em; }
    .vis-details { display: grid; grid-template-columns: 1fr; gap: 10px; font-size: 0.95em; color: #333; }
    .vis-details span { display: flex; justify-content: space-between; align-items: center; line-height: 1.4; padding-bottom: 5px; border-bottom: 1px dotted #e0e0e0; }
    .vis-details strong { color: #B71C1C; font-weight: 600; }
    .vis-details small { font-size: 0.85em; color: #555; font-weight: 400; margin-left: 5px; }

    .edit-btn { background: none; border: none; color: #0D47A1; font-size: 0.9em; cursor: pointer; text-decoration: underline; padding: 0; margin-left: 10px; }

    #downloadPdfLink { grid-column: 1 / -1; margin-top: 15px; text-align: center; cursor: pointer; color: #1B5E20; text-decoration: underline; padding: 8px 0; font-weight: 600; }
    #downloadPdfLink:hover { color: #2E7D32; }

    /* Modal/Popup Styles */
    .modal { position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); display: none; }
    .modal-content { background-color: #fefefe; margin: 5% auto; padding: 30px; border-radius: 10px; width: 90%; max-width: 700px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 20px; }
    .close-btn { color: #aaa; font-size: 28px; font-weight: bold; }
    .close-btn:hover, .close-btn:focus { color: #000; text-decoration: none; cursor: pointer; }
    .modal-input-group { margin-bottom: 15px; }
    .modal-input-group label { font-weight: 600; color: #0D47A1; margin-bottom: 5px; }
    .modal-submit { background-color: #1B5E20; margin-top: 15px; }
    .modal-submit:hover { background-color: #2E7D32; }
    .modal-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .modal-grid-span-2 { grid-column: 1 / -1; }
    .modal-disclaimer { margin-top: 15px; padding: 10px; background: #fffde7; border: 1px solid #ffeb3b; border-radius: 5px; font-size: 0.85em; color: #616161; }

  </style>
</head>
<body>
  <div class="main-wrapper">
    <div class="input-panel" id="formContainer">
      <h2>PeopleLink LED Video Wall Configuration</h2>
      <div id="enteredValuesDisplay" class="hidden">
          <span id="enteredSummaryText"></span><br>
          Actual Final Aspect Ratio: <strong><span id="aspectRatioValue">--</span></strong>
      </div>
      <div id="errorMessage" class="error-message hidden"></div>

      <div class="input-grid">
        <div class="input-group">
          <label for="productModel">LED Model / Pixel Pitch</label>
          <select id="productModel">
              <option value="">Select LED Model</option>
              <optgroup label="COB Models (16:9 Cabinet - 600x337.5mm)">
                  <option value="cob_09">PeopleLink COB (0.9375mm)</option>
                  <option value="cob_125">PeopleLink COB (1.25mm)</option>
                  <option value="cob_15">PeopleLink COB (1.5625mm)</option>
              </optgroup>
              <optgroup label="SMD Indoor Models (4:3 Cabinet - 640x480mm)">
                  <option value="indoor_186">PeopleLink SMD Indoor (1.86mm)</option>
                  <option value="indoor_20">PeopleLink SMD Indoor (2.0mm)</option>
                  <option value="indoor_25">PeopleLink SMD Indoor (2.5mm)</option>
              </optgroup>
              <optgroup label="SMD Outdoor Models (1:1 Cabinet - 960x960mm)">
                  <option value="outdoor_40">PeopleLink SMD Outdoor (4.0mm)</option>
                  <option value="outdoor_667">PeopleLink SMD Outdoor (6.67mm)</option>
                  <option value="outdoor_80">PeopleLink SMD Outdoor (8.0mm)</option>
                  <option value="outdoor_100">PeopleLink SMD Outdoor (10.0mm)</option>
              </optgroup>
          </select>
        </div>
        <div class="input-group">
          <label for="unit">Unit of Measurement</label>
          <select id="unit" onchange="toggleMeasurementFields()"> 
              <option value="">Select unit</option> 
              <option value="meters">Meters (m)</option> 
              <option value="feet">Feet (ft)</option> 
              <option value="inches">Inches (in) - Diagonal</option> 
          </select>
        </div>
        
        <div class="input-group" id="widthGroup">
          <label for="width" id="widthLabel">Desired Width (m)</label>
          <input type="number" id="width" placeholder="Enter desired width" min="0.1" step="0.01">
        </div>
        <div class="input-group" id="heightGroup">
          <label for="height" id="heightLabel">Desired Height (m)</label>
          <input type="number" id="height" placeholder="Enter desired height" min="0.1" step="0.01">
        </div>
        
        <div class="input-group hidden" id="diagonalGroup">
          <label for="diagonal" id="diagonalLabel">Desired Diagonal (inches)</label>
          <input type="number" id="diagonal" placeholder="Enter desired diagonal inches" min="10" step="1">
        </div>

        <div class="input-group" id="aspectRatioGroup">
          <label for="aspectRatio" id="aspectRatioLabel">Target Aspect Ratio (Optional)</label>
          <select id="aspectRatio"> 
              <option value="">Select ratio (Optional)</option> 
              <option value="16:9">16:9 (HD/UHD)</option> 
              <option value="16:10">16:10 (WUXGA)</option> 
              <option value="4:3">4:3 (Legacy)</option> 
              <option value="2:1">2:1 (Cinematic)</option>
              <option value="21:9">21:9 (Cinematic/2.37:1)</option>
              <option value="1:1">1:1 (Square)</option> 
          </select>
        </div>

        <button class="submit-btn" id="submitButton" onclick="showVisualization()">Calculate & Visualize System</button>
        <div class="back-btn-placeholder hidden"></div>
      </div>
    </div>

    <div class="visualization" id="visualization">
      
      <div class="output-grid">
        <div class="details-box">
            <h4>LED Wall Specifications</h4>
            <div class="vis-details">
                <span id="productName">Product Model: <strong>--</strong></span>
                <span id="pixelPitchDisplay">Pixel Pitch: <strong>--</strong></span>
                <span id="cabinetSize">Cabinet Size (WxH): <strong>--</strong></span>
                <span id="cabinetPixels">Cabinet Pixels (WxH): <strong>--</strong></span>
                <span id="numCabinets">Total Cabinets (WxH): <strong>--</strong></span>
                <span id="totalModules">Total Modules Required: <strong>--</strong></span>
                <span id="finalDimensions">**Actual Final Dimensions (WxH):** <strong>--</strong></span>
                <span id="finalDiagonal">Final Diagonal Size: <strong>--</strong></span>
                <span id="resolution">**Actual Final Resolution (WxH):** <strong>--</strong></span>
                <span id="finalArea">Final Area: <strong>--</strong></span>
                <span id="totalPixels">Total Pixels: <strong>--</strong></span>
                <span id="brightness">Brightness/Nits: <strong>--</strong></span>
            </div>
        </div>

        <div class="details-box">
            <h4>Control System Requirements <button class="edit-btn" onclick="openControllerModal()">Edit/View Components ‚öôÔ∏è</button></h4>
            <div class="vis-details" id="controlSystemDetails">
                <span style="grid-column: 1 / -1; font-weight: 700; color: #0D47A1; border-bottom: 1px solid #0D47A1; padding-bottom: 5px; margin-bottom: 5px; margin-top: 5px;">Power and Weight</span>
                <span id="cabinetWeight">Est. Total Wall Weight (incl. buffer): <strong>--</strong></span>
                <span id="wallPower">Estimated Max Power (W): <strong>--</strong></span>
                <span id="wallCurrent">Estimated Max Current (A @220V): <strong>--</strong></span>
                
                <span style="grid-column: 1 / -1; font-weight: 700; color: #0D47A1; border-bottom: 1px solid #0D47A1; padding-bottom: 5px; margin-bottom: 5px; margin-top: 10px;">Controllers</span>
                <span id="suggestedControllerModel">Suggested Controller Model: <strong>--</strong></span>
                <span id="requiredRecCards">Total Receiving Cards Required: <strong>--</strong></span>
                <span id="controllerPorts">Total Ethernet Ports Needed: <strong>--</strong></span>

                <div id="modularDetails" class="vis-details" style="grid-column: 1 / -1; gap: 5px; border-top: 1px dotted #e0e0e0; padding-top: 10px; margin-top: 5px;">
                    <span id="splicerSolution">Recommended Splicer Solution: <strong>--</strong></span>
                    <span id="sendingCardModel">Output Card: <strong>--</strong></span>
                    <span id="inputCardModel">Input Card: <strong>--</strong></span>
                </div>
            </div>
        </div>
      </div>
      
      <div class="vis-box" style="margin-top: 30px;">
          <h4>Physical Wall Visualization</h4>
          <div class="vis-content">
             <div class="grid" id="visGrid">
                 <div id="cabinetOverlay"></div>
                 <span class="dimension-label dim-top" id="visWidthLabel">-- W --</span>
                 <span class="dimension-label dim-right" id="visHeightLabel">-- H --</span>
             </div>
          </div>
      </div>


      <span id="downloadPdfLink" onclick="downloadPdf()">Download PDF Technical Summary üìÑ</span>

       <button class="back-btn" id="backButton" onclick="hideVisualization()">Modify Configuration</button>
    </div>

    <div id="controllerModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 style="margin:0; color:#0D47A1;">Edit Control System Components</h3>
          <span class="close-btn" onclick="closeControllerModal()">&times;</span>
        </div>
        
        <div class="modal-grid">
            <div class="modal-input-group modal-grid-span-2">
                <label for="modalControllerModel">Suggested Controller/Processor Model (Editable):</label>
                <input type="text" id="modalControllerModel" placeholder="e.g., VX600 Pro or H5 Modular Splicer">
            </div>

            <div class="modal-input-group">
                <label for="modalSplicerSolution">Recommended Splicer Solution (Editable, if H-Series):</label>
                <input type="text" id="modalSplicerSolution" placeholder="e.g., Novastar H-Series">
            </div>

            <div class="modal-input-group">
                <label for="modalMaxPortsPerCard">Max Ports per Output Card:</label>
                <input type="number" id="modalMaxPortsPerCard" min="1" step="1" placeholder="e.g., 20">
            </div>

            <div class="modal-input-group">
                <label for="modalOutputCardModel">Output Card Model (Per Max Ports):</label>
                <input type="text" id="modalOutputCardModel" placeholder="e.g., H_20xRJ45 Sending Card">
            </div>

            <div class="modal-input-group">
                <label for="modalInputCardModel">Input Card Model (Default):</label>
                <select id="modalInputCardModel">
                    </select>
            </div>
            
            <div class="modal-input-group">
                <label for="modalInputCardQty">Input Card Quantity:</label>
                <input type="number" id="modalInputCardQty" min="1" step="1" placeholder="e.g., 1">
            </div>
        </div>

        <div class="modal-disclaimer">
            <p><strong>Crucial Disclaimer:</strong> You can edit the types and quantities of input cards/sending cards and accessories as required. The system will regenerate a solution based on your pixel count and the *Max Ports per Output Card* value you enter.</p>
        </div>

        <button class="submit-btn modal-submit" onclick="applyModalChanges()">Apply Changes & Recalculate</button>
      </div>
    </div>


  </div>

  <script>
    // --- Constants ---
    const MM_PER_METER = 1000;
    const MM_PER_INCH = 25.4;
    const MM_PER_FOOT = MM_PER_INCH * 12;
    const PIXELS_PER_PORT_DEFAULT = 650000; // Standard for NovaStar Ethernet port bandwidth (approx 650K/port)
    
    // Safety Buffers (Requested by user)
    const POWER_BUFFER = 1.20; // 20%
    const WEIGHT_BUFFER = 1.20; // 20%

    // --- PeopleLink LED Models (V13 - No Change from V12) ---
    const LED_PRODUCTS = {
        'cob_09': { name: "PeopleLink COB (0.9375mm)", pitch_mm: 0.9375, cabW_mm: 600, cabH_mm: 337.5, cabPixW: 640, cabPixH: 360, modulesPerCab: 8, weight_kg: 4.6, nits_range: "600-1000", maxPower_W_m2: 300 },
        'cob_125': { name: "PeopleLink COB (1.25mm)", pitch_mm: 1.25, cabW_mm: 600, cabH_mm: 337.5, cabPixW: 480, cabPixH: 270, modulesPerCab: 8, weight_kg: 4.6, nits_range: "600-800", maxPower_W_m2: 300 },
        'cob_15': { name: "PeopleLink COB (1.5625mm)", pitch_mm: 1.5625, cabW_mm: 600, cabH_mm: 337.5, cabPixW: 384, cabPixH: 216, modulesPerCab: 8, weight_kg: 4.6, nits_range: "600-800", maxPower_W_m2: 300 }, 
        'indoor_186': { name: "PeopleLink SMD Indoor (1.86mm)", pitch_mm: 1.86, cabW_mm: 640, cabH_mm: 480, cabPixW: 344, cabPixH: 258, modulesPerCab: 6, weight_kg: 6.24, nits_range: "450-600", maxPower_W_m2: 560 }, 
        'indoor_20': { name: "PeopleLink SMD Indoor (2.0mm)", pitch_mm: 2.0, cabW_mm: 640, cabH_mm: 480, cabPixW: 320, cabPixH: 240, modulesPerCab: 6, weight_kg: 6.24, nits_range: "450-600", maxPower_W_m2: 560 }, 
        'indoor_25': { name: "PeopleLink SMD Indoor (2.5mm)", pitch_mm: 2.5, cabW_mm: 640, cabH_mm: 480, cabPixW: 256, cabPixH: 192, modulesPerCab: 6, weight_kg: 6.24, nits_range: "450-600", maxPower_W_m2: 560 }, 
        'outdoor_40': { name: "PeopleLink SMD Outdoor (4.0mm)", pitch_mm: 4.0, cabW_mm: 960, cabH_mm: 960, cabPixW: 240, cabPixH: 240, modulesPerCab: 18, weight_kg: 8.28, nits_range: "4500-5000", maxPower_W_m2: 937.5 }, 
        'outdoor_667': { name: "PeopleLink SMD Outdoor (6.67mm)", pitch_mm: 6.67, cabW_mm: 960, cabH_mm: 960, cabPixW: 144, cabPixH: 144, modulesPerCab: 18, weight_kg: 8.28, nits_range: "4500-5000", maxPower_W_m2: 937.5 }, 
        'outdoor_80': { name: "PeopleLink SMD Outdoor (8.0mm)", pitch_mm: 8.0, cabW_mm: 960, cabH_mm: 960, cabPixW: 120, cabPixH: 120, modulesPerCab: 18, weight_kg: 8.28, nits_range: "4500-5000", maxPower_W_m2: 937.5 }, 
        'outdoor_100': { name: "PeopleLink SMD Outdoor (10.0mm)", pitch_mm: 10.0, cabW_mm: 960, cabH_mm: 960, cabPixW: 96, cabPixH: 96, modulesPerCab: 18, weight_kg: 8.28, nits_range: "4500-5000", maxPower_W_m2: 937.5 } 
    };
    
    // --- New Controller Tiers (NovaStar Focus) ---
    const CONTROLLER_MODELS = [
        // Multimedia Players (Typically for simpler walls/small screens)
        // TB40 recommended for outdoor/lesser size indoor
        { name: "TB40", type: "Multimedia Player", ports: 2, maxPixels: 1300000, maxW: 10240, maxH: 8192, priority: 1 },
        { name: "TB60", type: "Multimedia Player", ports: 4, maxPixels: 2300000, maxW: 4096, maxH: 4096, priority: 2 },
        
        // All-In-One Processors
        { name: "VX400 Pro / DSP400 Pro", type: "All-in-One Processor", ports: 4, maxPixels: 2600000, maxW: 10240, maxH: 8192, priority: 3 },
        { name: "VX600 Pro / DSP600 Pro", type: "All-in-One Processor", ports: 6, maxPixels: 3900000, maxW: 10240, maxH: 8192, priority: 4 },
        { name: "VX1000 Pro / DSP1000 Pro", type: "All-in-One Processor", ports: 10, maxPixels: 6500000, maxW: 10240, maxH: 8192, priority: 5 },

        // High-End All-In-One
        { name: "4K Prime", type: "All-in-One Processor", ports: 16, maxPixels: 10400000, maxW: 16384, maxH: 8192, priority: 6 },
        { name: "4K Prime Pro", type: "All-in-One Processor", ports: 20, maxPixels: 13000000, maxW: 16384, maxH: 8192, priority: 7 },
        
        // Modular Splicers (Suggested for very large/complex walls > 13M)
        { name: "H2 / H5 / H9 / H15 / H20", type: "Modular Splicer (H-Series)", ports: 20, maxPixels: 26000000, maxW: 16384, maxH: 8192, priority: 8 }, 
    ].sort((a, b) => a.priority - b.priority);

    // New H-Series Card Defaults and Splicer Info
    const H_SERIES_DEFAULTS = {
        SPLICER_NAME: "Novastar H-Series (H2/H5/H9/H15/H20)",
        
        INPUT_CARD_OPTIONS: [
            { model: "H_1xHDMI2.0 input card (4K)", type: "4K Single Input" },
            { model: "H_2xHDMI2.0 input card (4K)", type: "4K Dual Input" },
            { model: "H_4xHDMI input card (1080P)", type: "HD Quad Input" },
        ],
        DEFAULT_INPUT_CARD_MODEL: "H_1xHDMI2.0 input card (4K)",
        DEFAULT_INPUT_CARD_QTY: 1,

        OUTPUT_CARD_20_PORTS: 20,
        OUTPUT_CARD_20_MODEL: "H_20xRJ45 Sending Card",
        
        // Fallback/Alternate Output Card (for users choosing 16-port option)
        OUTPUT_CARD_16_PORTS: 16,
        OUTPUT_CARD_16_MODEL: "H_16xRJ45+2xfiber sending card",
    };
    
    // --- Global Store and Helpers ---
    let finalCalculationData = {}; 

    function formatNumber(n,d=1){return n.toLocaleString(undefined,{minimumFractionDigits:d,maximumFractionDigits:d});}
    function formatLargeNumber(n){if(n>=1e6)return(n/1e6).toFixed(2)+"M";if(n>=1e3)return(n/1e3).toFixed(1)+"K";return n.toLocaleString();}
    function gcd(a,b){return b===0?a:gcd(b,a%b);}
    
    // --- UI/Modal Functions ---

    function toggleMeasurementFields(){
        const unit = document.getElementById('unit').value;
        const isDiagonal = (unit === 'inches');
        const isFeet = (unit === 'feet');

        let unitText = ' (m)';
        if (isFeet) unitText = ' (ft)';
        if (isDiagonal) unitText = ' (in)';

        document.getElementById('widthLabel').textContent = `Desired Width${unitText}`;
        document.getElementById('heightLabel').textContent = `Desired Height${unitText}`;
        document.getElementById('aspectRatioLabel').textContent = 'Target Aspect Ratio (Optional)';

        document.getElementById('widthGroup').classList.toggle('hidden', isDiagonal);
        document.getElementById('heightGroup').classList.toggle('hidden', isDiagonal);
        document.getElementById('diagonalGroup').classList.toggle('hidden', !isDiagonal);
        
        if (isDiagonal) {
            document.getElementById('width').value = '';
            document.getElementById('height').value = '';
        } else {
            document.getElementById('diagonal').value = '';
        }
        document.getElementById('errorMessage').classList.add('hidden');
    }

    function populateModalInputCards() {
        const select = document.getElementById('modalInputCardModel');
        select.innerHTML = '';
        H_SERIES_DEFAULTS.INPUT_CARD_OPTIONS.forEach(option => {
            const opt = document.createElement('option');
            opt.value = option.model;
            opt.textContent = option.model;
            select.appendChild(opt);
        });
    }

    function openControllerModal() {
        populateModalInputCards(); // Ensure input card options are loaded

        // Load current calculated/stored values into the modal fields
        const isHSeries = finalCalculationData.controllerType && finalCalculationData.controllerType.includes('Modular');
        
        document.getElementById('modalControllerModel').value = finalCalculationData.controllerOverrideName || finalCalculationData.controllerName.split('(')[0].trim();
        document.getElementById('modalSplicerSolution').value = finalCalculationData.splicerSolution || (isHSeries ? H_SERIES_DEFAULTS.SPLICER_NAME : 'N/A');
        
        document.getElementById('modalOutputCardModel').value = finalCalculationData.outputCardModel || H_SERIES_DEFAULTS.OUTPUT_CARD_20_MODEL;
        document.getElementById('modalMaxPortsPerCard').value = finalCalculationData.outputCardPorts || H_SERIES_DEFAULTS.OUTPUT_CARD_20_PORTS;
        
        // Select the currently suggested/saved input card model
        const inputCardSelect = document.getElementById('modalInputCardModel');
        inputCardSelect.value = finalCalculationData.inputCardModel || H_SERIES_DEFAULTS.DEFAULT_INPUT_CARD_MODEL;
        document.getElementById('modalInputCardQty').value = finalCalculationData.inputCardQty || H_SERIES_DEFAULTS.DEFAULT_INPUT_CARD_QTY;

        document.getElementById('controllerModal').style.display = 'block';
    }

    function closeControllerModal() {
        document.getElementById('controllerModal').style.display = 'none';
    }

    function applyModalChanges() {
        // Store overrides
        finalCalculationData.controllerOverrideName = document.getElementById('modalControllerModel').value;
        finalCalculationData.splicerSolution = document.getElementById('modalSplicerSolution').value;
        finalCalculationData.outputCardModel = document.getElementById('modalOutputCardModel').value;
        finalCalculationData.outputCardPorts = parseFloat(document.getElementById('modalMaxPortsPerCard').value);
        finalCalculationData.inputCardModel = document.getElementById('modalInputCardModel').value;
        finalCalculationData.inputCardQty = parseFloat(document.getElementById('modalInputCardQty').value);

        // Force re-run visualization with new parameters
        closeControllerModal();
        showVisualization(); 
    }

    // --- Core Calculation Logic ---

    function getSuggestedControllerModel(totalPixels, finalResW, finalResH, productKey) {
        
        const details = LED_PRODUCTS[productKey];
        const isOutdoor = productKey.startsWith('outdoor');
        const isSmallIndoor = totalPixels < 1500000; // Arbitrary definition of small indoor

        let suggestedController = null;

        // 1. Check for Multimedia Players (TB40/TB60)
        // Suggest TB for outdoor or small indoor walls unless resolution limits are hit
        if (isOutdoor || isSmallIndoor) {
             const suitableTB = CONTROLLER_MODELS.find(c => c.type === "Multimedia Player" && c.maxPixels >= totalPixels && c.maxW >= finalResW && c.maxH >= finalResH);
             if (suitableTB) {
                suggestedController = suitableTB;
             }
        }

        // 2. Check All-In-One Processors
        if (!suggestedController) {
            const suitableAIO = CONTROLLER_MODELS.find(c => c.type === "All-in-One Processor" && c.maxPixels >= totalPixels && c.maxW >= finalResW && c.maxH >= finalResH);
            if (suitableAIO) {
                suggestedController = suitableAIO;
            }
        }
        
        // 3. Check High-End AIOs (4K Prime)
        if (!suggestedController) {
            const suitable4K = CONTROLLER_MODELS.find(c => c.name.includes('4K Prime') && c.maxPixels >= totalPixels && c.maxW >= finalResW && c.maxH >= finalResH);
            if (suitable4K) {
                suggestedController = suitable4K;
            }
        }

        // 4. Default to Modular Splicer (H-Series) for massive walls or if no AIO/TB fits
        if (!suggestedController) {
            suggestedController = CONTROLLER_MODELS.find(c => c.type.includes("Modular")) || CONTROLLER_MODELS[CONTROLLER_MODELS.length - 1]; 
        }

        return suggestedController;
    }

    function calculateLEDWall(){
        // 1. Get User Input
        const productKey = document.getElementById('productModel').value;
        const unit = document.getElementById('unit').value;
        const widthInput = document.getElementById('width').value;
        const heightInput = document.getElementById('height').value;
        const diagonalInput = document.getElementById('diagonal').value;
        const aspectRatioKey = document.getElementById('aspectRatio').value;

        let inputW = parseFloat(widthInput);
        let inputH = parseFloat(heightInput);
        let inputD = parseFloat(diagonalInput);

        const errorDiv=document.getElementById('errorMessage');
        errorDiv.classList.add('hidden');
        
        // --- MANDATORY FIELD VALIDATION (WITH SCROLL FIX) ---
        if (!productKey || !unit || ((unit !== 'inches' && (!inputW && !inputH)) || (unit === 'inches' && !inputD))) {
            errorDiv.textContent = 'ERROR: Please select a Model, Unit, and enter valid dimensions to continue.';
            errorDiv.classList.remove('hidden');
            errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
            return null;
        }

        const isDiagonal = (unit === 'inches');
        const details = LED_PRODUCTS[productKey];
        const cabinetW_mm = details.cabW_mm;
        const cabinetH_mm = details.cabH_mm;
        
        // 2. Determine Desired Dimensions (W/H in mm) based on input and AR
        let desiredW_mm, desiredH_mm;
        let usedW_input, usedH_input, usedRatio = aspectRatioKey || 'None Specified';
        
        if (unit === 'inches') {
            const ratioToUse = aspectRatioKey || '16:9'; 
            const [ratioW, ratioH] = ratioToUse.split(':').map(Number);
            const ratioDiagonal = Math.sqrt(ratioW * ratioW + ratioH * ratioH);
            const factor = inputD / ratioDiagonal;

            desiredW_mm = ratioW * factor * MM_PER_INCH;
            desiredH_mm = ratioH * factor * MM_PER_INCH;

            usedW_input = ratioW; 
            usedH_input = ratioH;
            usedRatio = aspectRatioKey || '16:9 (Assumed)'; 

        } else {
            const unit_factor = (unit === 'meters') ? MM_PER_METER : MM_PER_FOOT;
            const hasW = !isNaN(inputW) && inputW > 0;
            const hasH = !isNaN(inputH) && inputH > 0;
            
            if (aspectRatioKey) {
                const [ratioW, ratioH] = aspectRatioKey.split(':').map(Number);
                if (hasW) {
                    usedW_input = inputW;
                    usedH_input = (inputW / ratioW) * ratioH;
                } else if (hasH) {
                    usedH_input = inputH;
                    usedW_input = (inputH / ratioH) * ratioW;
                } else {
                    usedW_input = inputW;
                    usedH_input = inputH;
                }
                
                desiredW_mm = usedW_input * unit_factor;
                desiredH_mm = usedH_input * unit_factor;

            } else {
                usedW_input = hasW ? inputW : (inputH * (cabinetW_mm / cabinetH_mm)); 
                usedH_input = hasH ? inputH : (inputW * (cabinetH_mm / cabinetW_mm));

                desiredW_mm = usedW_input * unit_factor;
                desiredH_mm = usedH_input * unit_factor;
                
                if(hasW && !hasH) usedRatio = `Inferred from Cabinet AR (${cabinetW_mm}:${cabinetH_mm})`;
                if(hasH && !hasW) usedRatio = `Inferred from Cabinet AR (${cabinetW_mm}:${cabinetH_mm})`;
            }
        }

        // 3. Calculate cabinets needed (round to nearest integer)
        let numCabW = Math.max(1, Math.round(desiredW_mm / cabinetW_mm));
        let numCabH = Math.max(1, Math.round(desiredH_mm / cabinetH_mm));
        
        const totalCabinets = numCabW * numCabH;
        const totalModules = totalCabinets * details.modulesPerCab;


        // 4. Calculate Final Actual Dimensions (in mm)
        const finalW_mm = numCabW * cabinetW_mm;
        const finalH_mm = numCabH * cabinetH_mm;

        // 5. Calculate Pixel Resolution
        const finalResW = numCabW * details.cabPixW;
        const finalResH = numCabH * details.cabPixH;
        const totalPixels = finalResW * finalResH;

        // 6. Calculate Aspect Ratio and Diagonal
        const ratioGCD = gcd(finalResW, finalResH);
        const aspectRatioText = `${finalResW / ratioGCD}:${finalResH / ratioGCD}`;
        const finalDiagonal_mm = Math.sqrt(finalW_mm * finalW_mm + finalH_mm * finalH_mm);
        const finalDiagonal_in = finalDiagonal_mm / MM_PER_INCH;
        const finalArea_m2 = (finalW_mm / MM_PER_METER) * (finalH_mm / MM_PER_METER);

        // 7. Calculate Power & Weight (WITH 20% BUFFER)
        const maxPower_W_buffered = (finalArea_m2 * details.maxPower_W_m2) * POWER_BUFFER; 
        const maxCurrent_A = maxPower_W_buffered / 220;
        const totalCabinetWeight_unbuffered = details.weight_kg * totalCabinets;
        const totalWallWeight_buffered = totalCabinetWeight_unbuffered * WEIGHT_BUFFER;

        // 8. Calculate Controller Requirements (Ports & Sending Cards)
        const suggestedController = getSuggestedControllerModel(totalPixels, finalResW, finalResH, productKey);
        const isHSeries = suggestedController.type.includes("Modular");
        
        // Use Modal/Default values for Output Cards
        const outputCardPorts = finalCalculationData.outputCardPorts || H_SERIES_DEFAULTS.OUTPUT_CARD_20_PORTS;
        const outputCardModel = finalCalculationData.outputCardModel || H_SERIES_DEFAULTS.OUTPUT_CARD_20_MODEL;
        const inputCardModel = finalCalculationData.inputCardModel || H_SERIES_DEFAULTS.DEFAULT_INPUT_CARD_MODEL;
        const inputCardQty = finalCalculationData.inputCardQty || H_SERIES_DEFAULTS.DEFAULT_INPUT_CARD_QTY;
        const splicerSolution = finalCalculationData.splicerSolution || (isHSeries ? H_SERIES_DEFAULTS.SPLICER_NAME : 'N/A');

        // Total required ports based on standard pixel bandwidth
        const requiredPorts = Math.max(1, Math.ceil(totalPixels / PIXELS_PER_PORT_DEFAULT)); 

        // Calculate required sending cards based on the selected/default output card
        const requiredSendCards = Math.max(1, Math.ceil(requiredPorts / outputCardPorts));

        // Apply controller name override if set in modal
        const controllerName = finalCalculationData.controllerOverrideName || suggestedController.name;
        
        // 9. Store data
        finalCalculationData = {
            ...finalCalculationData, // Preserve overrides
            productName: details.name,
            numCabW: numCabW,
            numCabH: numCabH,
            finalW_mm: finalW_mm,
            finalH_mm: finalH_mm,
            finalResW: finalResW,
            finalResH: finalResH,
            totalPixels: totalPixels,
            aspectRatioText: aspectRatioText,
            finalDiagonal_in: finalDiagonal_in,
            pixelPitch_mm: details.pitch_mm,
            totalCabinets: totalCabinets,
            totalModules: totalModules,
            totalRecCards: totalCabinets,
            maxPower_W: maxPower_W_buffered,
            maxCurrent_A: maxCurrent_A,
            totalWallWeight_buffered: totalWallWeight_buffered,
            nits_range: details.nits_range,
            
            // Controller/Card Details
            controllerName: controllerName,
            controllerType: suggestedController.type,
            requiredPorts: requiredPorts,
            outputCardPorts: outputCardPorts,
            outputCardModel: outputCardModel,
            requiredSendCards: requiredSendCards,
            inputCardModel: inputCardModel,
            inputCardQty: inputCardQty,
            splicerSolution: splicerSolution
        };

        return finalCalculationData;
    }

    function calculateDimensions(data) {
        const finalW_M = data.finalW_mm / MM_PER_METER;
        const finalH_M = data.finalH_mm / MM_PER_METER;
        const finalW_FT = data.finalW_mm / MM_PER_FOOT;
        const finalH_FT = data.finalH_mm / MM_PER_FOOT;
        return { finalW_M, finalH_M, finalW_FT, finalH_FT };
    }

    function showVisualization(){
        const data = calculateLEDWall();
        if (!data) return; 

        const { finalW_M, finalH_M, finalW_FT, finalH_FT } = calculateDimensions(data);

        // 1. Update Input Summary Display
        let summaryText;
        const unitSymbol = data.unit === 'meters' ? 'm' : (data.unit === 'feet' ? 'ft' : 'in');

        if (data.unit === 'inches') {
            summaryText = `Desired AR: <strong>${data.inputRatioKey}</strong>, Diag: <strong>${data.inputDiagonal.toFixed(1)} ${unitSymbol}</strong>`;
        } else if (data.inputRatioKey && data.inputRatioKey !== 'None Specified') {
            summaryText = `Input AR: <strong>${data.inputRatioKey}</strong>, **Used WxH:** <strong>${formatNumber(data.usedW_input, 2)}x${formatNumber(data.usedH_input, 2)} ${unitSymbol}</strong>`;
        } else {
            summaryText = `Desired WxH: <strong>${formatNumber(data.usedW_input, 2)}x${formatNumber(data.usedH_input, 2)} ${unitSymbol}</strong>`;
        }

        document.getElementById('enteredSummaryText').innerHTML = `Model: <strong>${data.productName}</strong>. ${summaryText}`;
        document.getElementById('aspectRatioValue').textContent = data.aspectRatioText;
        document.getElementById('enteredValuesDisplay').classList.remove('hidden');

        // 2. Animate and switch containers
        document.getElementById('formContainer').classList.add('minimized');
        document.getElementById('submitButton').classList.add('hidden');
        document.querySelector('.back-btn-placeholder').classList.remove('hidden');
        document.getElementById('visualization').classList.add('visible');

        // 3. Update Details Section (Column 1 - Wall Specs)
        document.getElementById('productName').innerHTML = `Product Model: <strong>${data.productName}</strong>`;
        document.getElementById('pixelPitchDisplay').innerHTML = `Pixel Pitch: <strong>${data.pixelPitch_mm} mm</strong>`;
        document.getElementById('cabinetSize').innerHTML = `Cabinet Size (WxH): <strong>${data.cabinetW_mm}mm x ${data.cabinetH_mm}mm</strong>`;
        document.getElementById('cabinetPixels').innerHTML = `Cabinet Pixels (WxH): <strong>${data.cabPixW} x ${data.cabPixH}</strong>`;
        document.getElementById('numCabinets').innerHTML = `Total Cabinets (WxH): <strong>${data.numCabW} x ${data.numCabH} = ${data.totalCabinets}</strong>`;
        document.getElementById('totalModules').innerHTML = `Total Modules Required: <strong>${data.totalModules}</strong><small> (${data.modulesPerCab} per cabinet)</small>`;
        document.getElementById('finalDimensions').innerHTML = `**Actual Final Dimensions (WxH):** <strong>${finalW_M.toFixed(2)}m x ${finalH_M.toFixed(2)}m</strong><small> (${finalW_FT.toFixed(2)}ft x ${finalH_FT.toFixed(2)}ft)</small>`;
        document.getElementById('finalDiagonal').innerHTML = `Final Diagonal Size: <strong>${data.finalDiagonal_in.toFixed(1)} in</strong>`;
        document.getElementById('resolution').innerHTML = `**Actual Final Resolution (WxH):** <strong>${data.finalResW} x ${data.finalResH}</strong>`;
        document.getElementById('finalArea').innerHTML = `Final Area: <strong>${data.finalArea_m2.toFixed(2)} m¬≤</strong>`;
        document.getElementById('totalPixels').innerHTML = `Total Pixels: <strong>${formatLargeNumber(data.totalPixels)}</strong>`;
        document.getElementById('brightness').innerHTML = `Brightness/Nits: <strong>${data.nits_range || 'N/A'} cd/m¬≤</strong>`;
        
        // 4. Update Details Section (Column 2 - Control System & Power)
        const totalWeightText = `${formatNumber(data.totalWallWeight_buffered, 1)} kg`;
        
        // Power and Weight
        document.getElementById('cabinetWeight').innerHTML = `Est. Total Wall Weight: <strong>${totalWeightText}</strong><small> (Calculated with ${WEIGHT_BUFFER*100}% structural buffer)</small>`;
        document.getElementById('wallPower').innerHTML = `Estimated Max Power: <strong>${formatNumber(data.maxPower_W, 0)} W</strong><small> (Incl. ${POWER_BUFFER*100}% buffer)</small>`;
        document.getElementById('wallCurrent').innerHTML = `Estimated Max Current: <strong>${data.maxCurrent_A.toFixed(2)} A</strong><small> (@220V)</small>`;

        // Controllers
        document.getElementById('suggestedControllerModel').innerHTML = `Suggested Controller Model: <strong>${data.controllerName}</strong><small> (${data.controllerType})</small>`;
        document.getElementById('requiredRecCards').innerHTML = `Total Receiving Cards Required: <strong>${data.totalRecCards}</strong><small> (Assumes 1 card per cabinet)</small>`;
        document.getElementById('controllerPorts').innerHTML = `Total Ethernet Ports Needed: <strong>${data.requiredPorts}</strong><small> (Based on ${formatLargeNumber(PIXELS_PER_PORT_DEFAULT)} pixels/port)</small>`;

        // Modular Details (Show/Hide based on controller type)
        const modularDetailsDiv = document.getElementById('modularDetails');
        const isHSeries = data.controllerType.includes("Modular");
        modularDetailsDiv.style.display = isHSeries ? 'grid' : 'none';

        if (isHSeries) {
            document.getElementById('splicerSolution').innerHTML = `Recommended Splicer Solution: <strong>${data.splicerSolution}</strong>`;
            document.getElementById('sendingCardModel').innerHTML = `Output Card: <strong>${data.requiredSendCards} x ${data.outputCardModel}</strong><small> (${data.outputCardPorts} ports/card)</small>`;
            document.getElementById('inputCardModel').innerHTML = `Input Card: <strong>${data.inputCardQty} x ${data.inputCardModel}</strong><small> (As per site requirement/number of inputs actual requirement)</small>`;
        }


        // 5. Update Visualization Grid
        const aspectRatio = data.finalW_mm / data.finalH_mm;
        const visualizationHeight = 300; 
        const visGrid = document.getElementById('visGrid');
        
        if (visualizationHeight * aspectRatio > 800) {
             visGrid.style.width = `800px`;
             visGrid.style.height = `${800 / aspectRatio}px`;
        } else {
             visGrid.style.height = `${visualizationHeight}px`;
             visGrid.style.width = `${visualizationHeight * aspectRatio}px`;
        }
        
        visGrid.style.margin = '0 auto';

        document.getElementById('visWidthLabel').textContent = `${finalW_M.toFixed(2)} m (W)`;
        document.getElementById('visHeightLabel').textContent = `${finalH_M.toFixed(2)} m (H)`;

        // Cabinet Overlay Visualization
        const cabinetOverlay = document.getElementById('cabinetOverlay');
        cabinetOverlay.innerHTML = '';
        cabinetOverlay.style.gridTemplateColumns = `repeat(${data.numCabW}, 1fr)`;
        cabinetOverlay.style.gridTemplateRows = `repeat(${data.numCabH}, 1fr)`;
        cabinetOverlay.style.display = 'grid';

        for (let r = 0; r < data.numCabH; r++) {
            for (let c = 0; c < data.numCabW; c++) {
                const cabDiv = document.createElement('div');
                cabDiv.style.border = '1px dashed rgba(13, 71, 161, 0.4)';
                cabDiv.style.boxSizing = 'border-box';
                cabinetOverlay.appendChild(cabDiv);
            }
        }

        document.getElementById('downloadPdfLink').classList.remove('hidden');
    }
    
    function hideVisualization(){
        document.getElementById('formContainer').classList.remove('minimized');
        document.getElementById('visualization').classList.remove('visible');
        document.getElementById('submitButton').classList.remove('hidden');
        document.querySelector('.back-btn-placeholder').classList.add('hidden');
        document.getElementById('downloadPdfLink').classList.add('hidden');
    }

    // --- PDF Generation ---
    function downloadPdf() {
        if (!finalCalculationData || finalCalculationData.totalPixels === 0) {
            alert("Please calculate the LED wall configuration first.");
            return;
        }

        const data = finalCalculationData;
        const { finalW_M, finalH_M, finalW_FT, finalH_FT } = calculateDimensions(data);
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4'); 

        let y = 10;
        const margin = 15;
        const lineHeight = 7;
        const pageW = doc.internal.pageSize.getWidth();
        const primaryColor = [13, 71, 161]; 
        const secondaryColor = [183, 28, 28]; 

        // 1. Header (Title)
        doc.setFontSize(20);
        doc.setTextColor(...secondaryColor);
        doc.text('PeopleLink LED Video Wall Technical Summary', pageW / 2, y, { align: 'center' });
        y += lineHeight * 1.5;

        // 2. Specifications
        doc.setFontSize(14);
        doc.setTextColor(...primaryColor); 
        doc.text('1. Screen & Cabinet Specifications', margin, y);
        y += lineHeight;

        const specsData = [
            ['Product Model', data.productName],
            ['Pixel Pitch (mm)', `${data.pixelPitch_mm} mm`],
            ['Cabinet Dimensions (mm)', `${data.cabinetW_mm}mm x ${data.cabinetH_mm}mm`],
            ['Cabinet Array (W x H)', `${data.numCabW} x ${data.numCabH}`],
            ['Total Cabinets Required', `${data.totalCabinets}`],
            ['Total Modules Required', `${data.totalModules}`],
            ['Brightness', data.nits_range ? `${data.nits_range} cd/m¬≤` : 'N/A'],
        ];

        doc.autoTable({ startY: y + 3, body: specsData, margin: { left: margin, right: margin, bottom: 0 }, theme: 'striped', styles: { fontSize: 9 } });
        y = doc.lastAutoTable.finalY + lineHeight;

        // 3. Wall Performance
        doc.setFontSize(14);
        doc.setTextColor(...primaryColor); 
        doc.text('2. Wall Performance & Resolution', margin, y);
        y += lineHeight;

        const performanceData = [
            ['Actual Final Dimensions (W x H)', `${finalW_M.toFixed(2)}m x ${finalH_M.toFixed(2)}m`],
            ['Actual Final Resolution (W x H)', `${data.finalResW} x ${data.finalResH}`],
            ['Aspect Ratio', data.aspectRatioText],
            ['Total Pixels', formatLargeNumber(data.totalPixels)],
            ['Final Diagonal Size', `${data.finalDiagonal_in.toFixed(1)} inches`],
            ['Final Area', `${data.finalArea_m2.toFixed(2)} m¬≤`],
        ];

        doc.autoTable({ startY: y + 3, body: performanceData, margin: { left: margin, right: margin, bottom: 0 }, theme: 'plain', styles: { fontSize: 9 } });
        y = doc.lastAutoTable.finalY + lineHeight;

        // 4. Power and Weight (New Section)
        doc.setFontSize(14);
        doc.setTextColor(...secondaryColor); 
        doc.text('3. Power and Weight', margin, y);
        y += lineHeight;

        const powerWeightData = [
            ['Est. Total Wall Weight', `${formatNumber(data.totalWallWeight_buffered, 1)} kg (Incl. ${WEIGHT_BUFFER*100}% structural buffer)`],
            ['Max Power Consumption', `${formatNumber(data.maxPower_W, 0)} W (Incl. ${POWER_BUFFER*100}% buffer)`],
            ['Max Current Draw (@220V)', `${data.maxCurrent_A.toFixed(2)} A`],
        ];

        doc.autoTable({ startY: y + 3, body: powerWeightData, margin: { left: margin, right: margin, bottom: 0 }, theme: 'striped', styles: { fontSize: 9 } });
        y = doc.lastAutoTable.finalY + lineHeight;
        
        // 5. Control System Details (New Section)
        doc.setFontSize(14);
        doc.setTextColor(...secondaryColor); 
        doc.text('4. Control System Requirements', margin, y);
        y += lineHeight;

        const controllerData = [
            ['Suggested Controller Model', `${data.controllerName} (${data.controllerType})`],
            ['Total Receiving Cards', `${data.totalRecCards} (Assumes 1 per cabinet)`],
            ['Total Ethernet Ports Required', `${data.requiredPorts} (Based on ${formatLargeNumber(PIXELS_PER_PORT_DEFAULT)}/port)`],
        ];
        
        if (data.controllerType.includes("Modular")) {
            controllerData.push(['Recommended Splicer Solution', data.splicerSolution]);
            controllerData.push(['Output Card', `${data.requiredSendCards} x ${data.outputCardModel}`]);
            controllerData.push(['Input Card', `${data.inputCardQty} x ${data.inputCardModel} (As per site requirement/number of inputs actual requirement)`]);
        }


        doc.autoTable({ startY: y + 3, body: controllerData, margin: { left: margin, right: margin, bottom: 0 }, theme: 'plain', styles: { fontSize: 9 } });
        y = doc.lastAutoTable.finalY + 8; 

        // 6. Disclaimer
        doc.setFontSize(8);
        doc.setTextColor(100, 100, 100);
        doc.text('Crucial Disclaimer: The suggested control components are a best-fit recommendation based on total pixel count and maximum resolution limits. Actual requirements for input cards and total controller capacity may vary based on site-specific video source needs and redundancy planning. The default input card model and quantity can be modified via the "Edit/View Components" button.', margin, y, { maxWidth: pageW - 2 * margin });

        doc.save(`PeopleLink_LED_Config_${data.finalResW}x${data.finalResH}.pdf`);
    }

    document.addEventListener('DOMContentLoaded', () => {
        toggleMeasurementFields();
        populateModalInputCards(); // Initialize input card options

        // Close modal when clicking outside
        window.onclick = function(event) {
          const modal = document.getElementById('controllerModal');
          if (event.target == modal) {
            modal.style.display = "none";
          }
        }
    });
  </script>
<footer class="text-center text-gray-500 text-sm mt-10">
    ¬© PeopleLink_Pra
</footer>
</body>
</html>

