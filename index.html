<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PeopleLink Active LED Configuration</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    /* Base styles */
    body { font-family: 'Inter', sans-serif; margin: 0; padding: 40px; background: #ffffff; color: #333; font-size: 14px; }
    .container { background: rgba(255, 255, 255, 0.95); max-width: 600px; margin: auto; padding: 30px 40px; border-radius: 16px; box-shadow: 0 8px 30px rgba(0,0,0,0.15); color: #212121; overflow: hidden; margin-bottom: 30px; transition: height 0.6s ease-out, padding 0.6s ease-out, opacity 0.6s ease-out; height: auto; max-height: 1000px; opacity: 1; }
    .container.minimized { height: 115px; padding-top: 15px; padding-bottom: 10px; opacity: 0.95; overflow: hidden; background: rgba(245, 245, 245, 0.9); }
    .container.minimized > *:not(h2):not(#enteredValuesDisplay):not(.back-btn-placeholder) { opacity: 0; max-height: 0; overflow: hidden; transition: opacity 0.3s ease-out, max-height 0.3s ease-out; pointer-events: none; }
    .container.minimized h2 { margin-bottom: 5px; }
    .container.minimized #enteredValuesDisplay { display: block !important; opacity: 1; transition: opacity 0.3s ease-out 0.3s; }
    h2 { text-align: center; color: #0D47A1; margin-top: 0; margin-bottom: 5px; transition: margin 0.6s ease-out; }
    #enteredValuesDisplay { text-align: center; font-size: 0.95em; color: #444; margin-bottom: 15px; line-height: 1.4; }
    #enteredValuesDisplay strong { font-weight: 600; color: #1B5E20; }
    label { display: block; margin-top: 15px; font-weight: 600; color: #1B5E20; }
    select, input[type="number"], input[type="text"] { width: 100%; padding: 10px; margin-top: 5px; font-size: 14px; border: 1px solid #ccc; border-radius: 6px; transition: border-color 0.3s; font-family: 'Inter', sans-serif; box-sizing: border-box; }
    select:focus, input:focus { border-color: #B71C1C; outline: none; }
    .submit-btn, .back-btn { margin-top: 30px; background-color: #0D47A1; color: white; padding: 12px; border: none; border-radius: 6px; font-size: 16px; width: 100%; cursor: pointer; transition: background-color 0.3s, opacity 0.3s ease-out; }
    .submit-btn:hover, .back-btn:hover { background-color: #1565C0; }
    .back-btn { background-color: #6c757d; margin-top: 20px; }
    .back-btn:hover { background-color: #5a6268; }
    .hidden { display: none !important; }
    .error-message { color: #B71C1C; font-weight: bold; text-align: center; margin-top: 15px; padding: 5px; min-height: 20px; transition: opacity 0.3s ease-out; }
    .error-message.hidden { opacity: 0; }
    .visualization { background: #f8f9fa; max-width: 800px; margin: 0 auto; padding: 30px; border-radius: 16px; box-shadow: 0 8px 30px rgba(0,0,0,0.15); color: #212121; opacity: 0; max-height: 0; overflow-y: auto; /* Changed from hidden */ transition: opacity 0.6s ease-out, max-height 1s ease-out, padding 0.6s ease-out; }
    .visualization.visible { opacity: 1; max-height: 90vh; /* Increased max-height */ padding: 30px; }
    .vis-content { position: relative; width: 100%; margin-bottom: 20px; min-height: 150px; padding-top: 35px; padding-right: 45px; padding-bottom: 10px; box-sizing: border-box; }
    .grid { position: relative; width: 100%; border: 1px solid #dee2e6; min-height: 100px; transition: background 0.5s ease; overflow: hidden; }
    #cabinetOverlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; box-sizing: border-box; pointer-events: none; z-index: 5; border: 1px solid rgba(0,0,0,0.1); }
    .dimension-label { position: absolute; color: #333; background: rgba(255, 255, 255, 0.85); padding: 3px 6px; font-size: 0.9em; border-radius: 3px; white-space: nowrap; z-index: 10; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .dim-top { top: 5px; left: 50%; transform: translateX(-50%); }
    .dim-right { top: 50%; right: 10px; transform: translateY(-50%) rotate(90deg); transform-origin: center center; }
    .vis-details { margin-top: 20px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px 25px; font-size: 0.95em; color: #333; }
    .vis-details span, .vis-details span[onclick] { display: block; line-height: 1.4; }
    .vis-details strong { color: #0D47A1; }
    .vis-details small { font-size: 0.9em; color: #555; }
    #suggestedController strong { cursor: pointer; text-decoration: underline; text-decoration-color: #aaa; }
    #suggestedController strong:hover { color: #1565C0; }
     #downloadPdfLink { grid-column: 1 / -1; margin-top: 15px; text-align: center; cursor: pointer; color: #1B5E20; text-decoration: underline; padding: 8px 0; font-weight: 600; }
    #downloadPdfLink:hover { color: #2E7D32; }
    #popupOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); z-index: 998; display: none; opacity: 0; transition: opacity 0.3s ease-out; }
    #popupOverlay.visible { display: block; opacity: 1; }
    #controllerInfoPopup { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: #fff; color: #333; padding: 25px 30px; border-radius: 10px; box-shadow: 0 5px 25px rgba(0,0,0,0.2); min-width: 350px; max-width: 550px; z-index: 999; display: none; opacity: 0; transform: translate(-50%, -50%) scale(0.9); transition: opacity 0.3s ease-out, transform 0.3s ease-out; }
    #controllerInfoPopup.visible { display: block; opacity: 1; transform: translate(-50%, -50%) scale(1.0); }
    #controllerInfoPopup h3 { margin-top: 0; color: #0D47A1; text-align: center; }
    #popupContent p { margin: 8px 0; line-height: 1.5; font-size: 0.95em; }
    #popupContent strong { color: #1B5E20; }
    #popupContent ul { margin-top: 5px; padding-left: 20px; list-style: disc;}
    #popupContent li { margin-bottom: 4px;}
    #popupCloseBtn { position: absolute; top: 10px; right: 15px; font-size: 1.6em; color: #888; background: none; border: none; cursor: pointer; line-height: 1; }
    #popupCloseBtn:hover { color: #333; }

    /* Budgetary Quote Styles */
    .budgetary-quote { margin-top: 30px; padding-top: 20px; border-top: 1px solid #dee2e6; }
    .budgetary-quote h3 { color: #0D47A1; text-align: center; margin-bottom: 15px; font-size: 1.2em; }
    .budgetary-quote table { width: 100%; border-collapse: collapse; margin-bottom: 15px; font-size: 0.9em; }
    .budgetary-quote th, .budgetary-quote td { border: 1px solid #e0e0e0; padding: 8px 10px; text-align: left; vertical-align: top; } /* Added vertical-align */
    .budgetary-quote th { background-color: #f5f5f5; font-weight: 600; color: #444; }
    .budgetary-quote th:first-child, .budgetary-quote td:first-child { width: 40px; text-align: center; } /* S.No. width */
    .budgetary-quote td:nth-child(4), /* Qty */
    .budgetary-quote td:nth-child(5), /* Unit Price */
    .budgetary-quote td:nth-child(6) { /* Total */
      text-align: right;
      white-space: nowrap;
    }
     .budgetary-quote td:nth-child(3) { /* Code */
       font-size: 0.9em;
       color: #555;
       word-break: break-all; /* Break long codes */
     }
    .budgetary-quote .totals-section { margin-top: 15px; padding-top: 15px; border-top: 1px dashed #ccc; text-align: right; font-size: 0.95em; line-height: 1.6; }
    .budgetary-quote .totals-section span { display: block; margin-bottom: 5px; }
    .budgetary-quote .totals-section strong { color: #B71C1C; font-size: 1.1em; }
    .budgetary-quote .quote-disclaimer { font-size: 0.85em; color: #777; margin-top: 15px; text-align: center; line-height: 1.5; } /* Added line-height */

    /* NEW CSS: Terms & Conditions Styles */
    .terms-and-conditions { 
        margin-top: 30px; 
        padding-top: 20px; 
        border-top: 1px solid #dee2e6; 
    }
    .terms-and-conditions h3 { 
        color: #0D47A1; 
        text-align: center; 
        margin-bottom: 15px; 
        font-size: 1.2em; 
    }
    .terms-and-conditions ul { 
        list-style: disc; 
        padding-left: 20px; 
        margin: 0; 
        font-size: 0.9em; 
        line-height: 1.6;
        display: grid;
        grid-template-columns: 1fr 1fr; /* Display in two columns for better readability */
        gap: 5px 20px;
    }
    .terms-and-conditions li { 
        margin-bottom: 5px; 
    }
    /* END NEW CSS */

  </style>
</head>
<body>
  <div class="container" id="formContainer">
    <h2>PeopleLink Active LED Configuration</h2>
    <div id="enteredValuesDisplay" class="hidden">
        <span id="enteredSummaryText"></span><br>
        Final Aspect Ratio: <strong id="aspectRatioValue">--</strong>
    </div>
    <div id="errorMessage" class="error-message hidden"></div>
    <label for="ledType">LED Type</label>
    <select id="ledType" onchange="updateViewingDistances()"> <option value="">Select LED Type</option> <option value="cob">CoB LED (Indoor)</option> <option value="smdIndoor">SMD LED (Indoor)</option> <option value="smdOutdoor">SMD LED (Outdoor)</option> </select>
    <label for="viewingDistance">Viewing Distance</label>
    <select id="viewingDistance"> <option value="">Select viewing distance</option> </select>
    <label for="unit">Unit of Measurement</label>
    <select id="unit" onchange="toggleMeasurementFields()"> <option value="">Select unit</option> <option value="meters">Meters (m)</option> <option value="feet">Feet (ft)</option> <option value="inches">Inches (in) - Diagonal</option> </select>
    <label for="width" id="widthLabel">Desired Width (X)</label>
    <input type="number" id="width" placeholder="Enter desired width">
    <label for="height" id="heightLabel">Desired Height (Y)</label>
    <input type="number" id="height" placeholder="Enter desired height">
    <label for="diagonal" id="diagonalLabel" class="hidden">Desired Diagonal (Z)</label>
    <input type="number" id="diagonal" placeholder="Enter desired diagonal inches">
    <label for="aspectRatio" id="aspectRatioLabel" class="hidden">Aspect Ratio</label>
    <select id="aspectRatio" class="hidden"> <option value="">Select ratio</option> <option value="16:10">16:10</option> <option value="16:9">16:9</option> <option value="4:3">4:3</option> <option value="2:1">2:1</option> <option value="1:1">1:1</option> </select>
    <button class="submit-btn" id="submitButton" onclick="showVisualization()">Calculate & Visualize</button>
    <div class="back-btn-placeholder hidden"></div>
  </div>

  <div class="visualization" id="visualization">
    <div class="vis-content">
       <div class="grid" id="visGrid"><div id="cabinetOverlay"></div></div>
       <span class="dimension-label dim-top" id="visWidthLabel">-- W --</span>
       <span class="dimension-label dim-right" id="visHeightLabel">-- H --</span>
    </div>
    <div class="vis-details">
      <span id="pixelPitchDisplay">Pixel Pitch: <strong>--</strong></span>
      <span id="finalDimensions">Final Dimensions (WxH): <strong>--</strong></span>
      <span id="finalArea">Final Area: <strong>--</strong></span>
      <span id="finalDiagonal">Final Diagonal Size: <strong>--</strong></span>
      <span id="resolution">Resolution (WxH): <strong>--</strong></span>
      <span id="totalPixels">Total Pixels: <strong>--</strong></span>
      <span id="cabinetSize">Cabinet Size: <strong>--</strong></span>
      <span id="numCabinets">Total Cabinets (WxH): <strong>--</strong></span>
      <span id="moduleSize">Module Size: <strong>--</strong></span>
      <span id="numModules">Total Modules (WxH): <strong>--</strong></span>
      <span id="requiredPorts">Required Sending Ports: <strong>--</strong></span>
      <span id="cabinetsPerPort">Cabinets/Port (Max): <strong>--</strong></span>
      <span id="suggestedController" data-controller-name="">Suggested Controller: <strong>--</strong></span>
       <span id="aspectRatioDisplayPDF" class="hidden">Aspect Ratio: <strong>--</strong></span>
      <span id="spareModulesPDF" class="hidden">Spare Modules: <strong>--</strong></span>
      <span id="downloadPdfLink" class="hidden" onclick="downloadPdf()">Download PDF Summary</span>
    </div>

    <div class="budgetary-quote hidden" id="budgetaryQuoteSection">
        <h3>Budgetary Quote (INR)</h3>
        <table>
            <thead>
                <tr>
                    <th>S.No.</th>
                    <th>Product Name</th>
                    <th>Product Code</th>
                    <th>Qty</th>
                    <th>Unit ASP</th>
                    <th>Total ASP</th>
                </tr>
            </thead>
            <tbody id="quoteTableBody">
                </tbody>
        </table>
        <div class="totals-section">
            <span>Sub-Total: <span id="quoteSubTotal">₹ 0.00</span></span>
            <span>GST @ 28% (Hardware): <span id="quoteGstHardware">₹ 0.00</span></span>
            <span>GST @ 18% (Controller/Services): <span id="quoteGstService">₹ 0.00</span></span>
            <span><strong>Grand Total:</strong> <strong id="quoteGrandTotal">₹ 0.00</strong></span>
        </div>
        <p class="quote-disclaimer" id="quoteDisclaimer">
            Disclaimer: This is a system-generated budgetary quote based on available Average Selling Price (ASP) data. Prices are indicative and subject to change. Final quote may vary based on exact configuration, site conditions, and promotions. Excludes: Cabling, Structure, Cladding, Power Distribution, Plywood, 3rd Party Integration, Speakers, Rack.
        </p>
    </div>

    <div class="terms-and-conditions" id="termsAndConditionsSection">
        <h3>Standard Terms & Conditions for Active LED</h3>
        <ul id="termsList">
            </ul>
    </div>
    <button class="back-btn" id="backButton" onclick="hideVisualization()">Modify Configuration</button>
  </div>

  <div id="popupOverlay" onclick="hidePopup()"></div>
  <div id="controllerInfoPopup">
      <button id="popupCloseBtn" onclick="hidePopup()">×</button>
      <h3 id="popupTitle">Controller Details</h3>
      <div id="popupContent"></div>
  </div>

  <script>
    // --- Constants ---
    const MM_PER_METER=1000;const MM_PER_INCH=25.4;const MM_PER_FOOT=MM_PER_INCH*12;const PIXELS_PER_SENDING_PORT=650000;
    // const DEFAULT_H_INPUT_CARD="H_2xHDMI2.0+DP1.2"; // No longer needed as default for quote logic
    const DEFAULT_H_SENDING_CARD="H_16xRJ45+2xFiber"; // Default sending card (<=16 ports)
    const DEFAULT_H_PREVIEW_CARD="H_2xRJ45+1xHDMI1.3"; // Default preview card
    const QUOTE_DEFAULT_H_INPUT_CARD = "H_1xHDMI2.0"; // Input card specifically for quote
    const QUOTE_ALT_H_SENDING_CARD = "H_20xRJ45"; // Sending card for > 16 ports
    const ALT_SENDING_CARD_PORTS = 20; // Ports on the alternate sending card
    const SENDING_CARD_PORTS=16; // Ports on the default H-series sending card
    const MULTIFUNCTION_CARD_KEY = 'MFK300'; // Key for multifunction card pricing

    // SIMPLE PLACEHOLDER LOGO (Replace if you have the correct Base64 for your logo)
    const PEOPLELINK_LOGO_BASE64 = 'data:image/png;logo';
    const PEOPLELINK_LOGO_ASPECT_RATIO = 1; // Simple square placeholder
    const GST_HARDWARE = 0.28; // Cabinets, Modules
    const GST_SERVICES_CONTROLLER = 0.18; // Controller, Cards, Install, Transport, Multifunction Card

    // --- Get Element References ---
    const formContainer=document.getElementById('formContainer'),visualizationContainer=document.getElementById('visualization'),ledTypeSelect=document.getElementById('ledType'),viewingDistanceSelect=document.getElementById('viewingDistance'),unitSelect=document.getElementById('unit'),widthInput=document.getElementById('width'),heightInput=document.getElementById('height'),diagonalInput=document.getElementById('diagonal'),aspectRatioSelect=document.getElementById('aspectRatio'),errorDiv=document.getElementById('errorMessage'),submitButton=document.getElementById('submitButton'),backButtonPlaceholder=document.querySelector('.back-btn-placeholder'),enteredValuesDisplay=document.getElementById('enteredValuesDisplay'),enteredSummaryTextSpan=document.getElementById('enteredSummaryText'),aspectRatioValueSpan=document.getElementById('aspectRatioValue'),aspectRatioDisplayPDFSpan=document.getElementById('aspectRatioDisplayPDF'),spareModulesPDFSpan=document.getElementById('spareModulesPDF'),visGrid=document.getElementById('visGrid'),cabinetOverlay=document.getElementById('cabinetOverlay'),visWidthLabel=document.getElementById('visWidthLabel'),visHeightLabel=document.getElementById('visHeightLabel'),finalDimensionsSpan=document.getElementById('finalDimensions'),finalAreaSpan=document.getElementById('finalArea'),finalDiagonalSpan=document.getElementById('finalDiagonal'),resolutionSpan=document.getElementById('resolution'),totalPixelsSpan=document.getElementById('totalPixels'),pixelPitchDisplaySpan=document.getElementById('pixelPitchDisplay'),cabinetSizeSpan=document.getElementById('cabinetSize'),moduleSizeSpan=document.getElementById('moduleSize'),numModulesSpan=document.getElementById('numModules'),numCabinetsSpan=document.getElementById('numCabinets'),requiredPortsSpan=document.getElementById('requiredPorts'),suggestedControllerSpan=document.getElementById('suggestedController'),cabinetsPerPortSpan=document.getElementById('cabinetsPerPort'),popupOverlay=document.getElementById('popupOverlay'),controllerInfoPopup=document.getElementById('controllerInfoPopup'),popupTitle=document.getElementById('popupTitle'),popupContent=document.getElementById('popupContent'),
    downloadPdfLink=document.getElementById('downloadPdfLink');

    // --- Data Store ---
    // UPDATED module dimensions based on image (SMD Indoor height changed)
    // CORRECTED modulesPerCabH for SMD Indoor
    const ledDetails={
        cob:{
            name:"CoB LED (Indoor)",
            baseDetails:{moduleW_mm:150,moduleH_mm:168.75,cabinetW_mm:600,cabinetH_mm:337.5,modulesPerCabW:4,modulesPerCabH:2}, // 4x2 = 8 mods/cab
            distances:{"3' (0.9 Mtr)":0.9375,"4' (1.25 Mtr)":1.25,"5' (1.5 Mtr)":1.5625}
        },
        smdIndoor:{
            name:"SMD LED (Indoor)",
            baseDetails:{moduleW_mm:320,moduleH_mm:160,cabinetW_mm:640,cabinetH_mm:480,modulesPerCabW:2,modulesPerCabH:3}, // CORRECTED: 640/320=2, 480/160=3 => 2x3 = 6 mods/cab
            distances:{"4' (1.25 Mtr)":1.25,"5' (1.5 Mtr)":1.5385,"6' (1.86 Mtr)":1.86,"7' (2 Mtr)":2,"8' (2.5 Mtr)":2.5}
        },
        smdOutdoor:{
            name:"SMD LED (Outdoor)",
            baseDetails:{moduleW_mm:320,moduleH_mm:160,cabinetW_mm:960,cabinetH_mm:960,modulesPerCabW:3,modulesPerCabH:6}, // 3x6 = 18 mods/cab
            distances:{"8' (2.5 Mtr)":2.5,"13' (4 Mtr)":4,"16.5' (5 Mtr)":5,"20' (6 Mtr)":6.67,"26' (8 Mtr)":8,"33' (10 Mtr)":10}
        }
    };
    // === STRICTLY UPDATED Controller data based on the LATEST image ===
    // Including Max Input Cards and Correct Output Card count/limit
    const controllers=[
        {name:"TB40",maxPixels:1300000,sendingPorts:2,outputCardSlots:0, maxInputCards: null, isHSeries:!1,details:"2x Main Eth Outputs (1 Backup). Android OS."}, // Non-H: outputCardSlots represents physical slots, maxInputCards is null
        {name:"TB60",maxPixels:2300000,sendingPorts:4,outputCardSlots:0, maxInputCards: null, isHSeries:!1,details:"4x Main Eth Outputs. Android OS."},
        {name:"VX400",maxPixels:2600000,sendingPorts:4,outputCardSlots:0, maxInputCards: null, isHSeries:!1,details:"4x Eth Outputs. Inputs: 3G-SDI, HDMI 1.3, DVI."},
        {name:"VX600",maxPixels:3900000,sendingPorts:6,outputCardSlots:0, maxInputCards: null, isHSeries:!1,details:"6x Eth Outputs. Inputs: 3G-SDI, HDMI 1.3, DVI. Layers: 1 Main + 2 PIP."},
        {name:"VX1000",maxPixels:6500000,sendingPorts:10,outputCardSlots:0, maxInputCards: null, isHSeries:!1,details:"10x Eth Outputs. Inputs: 3G-SDI, HDMI 1.4, DVI(HDMI 1.4). Layers: 1 Main + 2 PIP."},
        {name:"4K-Prime",maxPixels:10000000,sendingPorts:16,outputCardSlots:0, maxInputCards: null, isHSeries:!1,details:"16x Eth + 4x OPT Outputs. Inputs: DP 1.2, HDMI 2.0, DVI(4). DVI Mosaic. HDR. 10-bit."}, // Updated maxPixels
        // H-Series: outputCardSlots represents "Max. Output Cards" count from image
        {name:"H2",maxPixels:26000000,sendingPorts:40,outputCardSlots:2, maxInputCards: 4, isHSeries:!0,details:"Modular (2U Rack). Max 4 input cards. Max 2 Output cards."}, // Details updated
        {name:"H5",maxPixels:39000000,sendingPorts:60,outputCardSlots:3, maxInputCards: 10, isHSeries:!0,details:"Modular (5U Rack). Max 10 input cards. Max 3 Output cards."}, // Details updated
        {name:"H9",maxPixels:65000000,sendingPorts:100,outputCardSlots:5, maxInputCards: 15, isHSeries:!0,details:"Modular (9U Rack). Max 15 input cards. Max 5 Output cards."}, // Details updated
        {name:"H15",maxPixels:130000000,sendingPorts:200,outputCardSlots:10, maxInputCards: 30, isHSeries:!0,details:"Modular (15U Rack). Max 30 input cards. Max 10 Output cards."}, // Details updated
        {name:"H15 Enhanced",maxPixels:208000000,sendingPorts:320,outputCardSlots:16, maxInputCards: 30, isHSeries:!0,details:"Enhanced H15. Modular (15U Rack). Max 30 input cards. Max 16 Output cards."}, // Details updated
        {name:"H20",maxPixels:260000000,sendingPorts:400,outputCardSlots:20, maxInputCards: 40, isHSeries:!0,details:"Modular (20U Rack). Max 40 input cards. Max 20 Output cards."} // Details updated
        // H9 Enhanced removed as it wasn't distinctly defined in the last spec image provided.
    ].sort((a,b)=>a.maxPixels-b.maxPixels);
    // === End of Controller Data Update ===
    const TERMS_AND_CONDITIONS=["Taxes on the Video Wall Components is 28% and Controller is at 18%","Warranty 1 Year","Required Fibber or CAT6 Cables (as per the drawing) to be laid by Client or SI.","Required Uninterrupted Power Cables/Points/Distribution Box (as per the drawing) is in Client's or SI's Scope.","Scaffolding or Man Lift, if required at the site, will be under SI/Client's Scope","Any cladding(Covering of sides of the screen) if required will be under SI/Client’s Scope","Any integration of third-party product will be under Client's/SI's Scope","Rack for Controller under SI's Scope (One required at the Server Room and other behind the screen).","Require Flat Surface for Installation of LED Wall along with fabrication as per the design shared by our team.","Content for the above Configuration with respect to the Aspect Ratio and Resolution shall be under Client's/SI's Scope.","Mounting Structure and Enclosure will be charged extra as per Site Conditions/Scope of Work.","Speakers shall be Extra on actuals by Client/SI.","Installation & Configuration under Client/SI Scope.","Metal frame (Aluminum/Iron/Steel) of the dimension of video wall is mandatory to be placed on wall, will be under Client's/SI's Scope","Plywood of appropriate (15-18mm) dimension need to be placed on iron frame before placing/fixing the Cabinets, will be under Client's/SI's Scope","Transportation Extra"];

    // --- Pricing Data (from OCR, including productName) ---
     const productPricing = {
        cabinets: {
            cob: { // Using Product Code as key for ASP, but need productName lookup
                '0.9375': { code: 'PPL-COB-MDL-CU-09', asp: 152594.00, productName: 'COB Cabinet (0.9mm Pitch)' }, // Name derived from context
                '1.25':   { code: 'PPL-COB-MDL-CU-12', asp: 70575.00, productName: 'COB Cabinet (1.25mm Pitch)' }, // Name derived from context
                '1.5625': { code: 'PPL-COB-MDL-CU-15', asp: 59130.00, productName: 'COB Cabinet (1.56mm Pitch)' } // Name derived from context
            },
            smdIndoor: { code: 'PPL-ALD-CU', asp: 18817.00, productName: 'PeopleLink ActiveLED | Video Wall Cabinet Unit' },
            smdOutdoor: { code: 'PPL-ALD-CU-OUTDR', asp: 71740.00, productName: 'PeopleLink ActiveLED | Outdoor Video Wall Cabinet Unit' }
        },
        modules: {
            smdIndoor: {
                '1.25':   { code: 'PDS-TP-15-SP', asp: 15597.00, productName: 'PeopleLink ActiveLED | 1.25PP Video LED Modules' },
                '1.5385': { code: 'PDS-TP-15-ST', asp: 9791.00, productName: 'PeopleLink ActiveLED | 1.5PP Video LED Modules' }, // Mapped 1.5PP
                '1.86':   { code: 'PDS-TP-40-T', asp: 4812.00, productName: 'PeopleLink ActiveLED | 1.8PP Video LED Modules' },
                '2':      { code: null, asp: 0, productName: null }, // Fallback needed
                '2.5':    { code: 'PDS-TP-15-T', asp: 4033.00, productName: 'PeopleLink ActiveLED | 2.5PP Video LED Modules' }
            },
            smdOutdoor: {
                '2.5': { code: null, asp: 0, productName: null }, // Fallback needed
                '4':   { code: null, asp: 0, productName: null }, // Fallback needed
                '5':   { code: null, asp: 0, productName: null }, // Fallback needed
                '6.67':{ code: 'PDS-TP-32-T', asp: 2206.00, productName: 'PeopleLink Outdoor Active LED | 6.6PP Video LED Modules' }, // Mapped 6.6PP
                '8':   { code: null, asp: 0, productName: null }, // Fallback needed
                '10':  { code: null, asp: 0, productName: null } // Fallback needed
            }
        },
        controllers: {
            'TB40':       { code: 'TP-VWC-NS-TB40', asp: 34670.00, productName: 'PeopleLink ActiveLED | Novastar TB40 LED Video Wall Controller' },
            'TB60':       { code: null, asp: 0, productName: null }, // Fallback needed
            'VX400':      { code: 'TP-VWC-NS-VX400', asp: 104471.00, productName: 'PeopleLink ActiveLED | Novastar LED Video Wall Controller - VX400' },
            'VX600':      { code: 'TP-VWC-NS-VX600', asp: 131400.00, productName: 'PeopleLink ActiveLED | Novastar LED Video Wall Controller - VX600' },
            'VX1000':     { code: 'TP-VWC-NS-VX1000', asp: 148500.00, productName: 'PeopleLink ActiveLED | Novastar LED Video Wall Controller - VX1000' },
            '4K-Prime':   { code: 'TP-VWC-NS-4K-PRM', asp: 533330.00, productName: 'PeopleLink ActiveLED | Novastar 4K Prime LED Video Wall Controller' },
            'H2':         { code: 'TP-XMF-H2', asp: 72500.00, productName: 'PeopleLink Active LED | Novastar LED Video Wall Controller - Mainframe of H2' },
            'H5':         { code: 'TP-XMF-H5', asp: 142100.00, productName: 'PeopleLink Active LED | Novastar LED Video Wall Controller - Mainframe of H5' },
            'H9':         { code: 'TP-XMF-H9', asp: 232000.00, productName: 'PeopleLink Active LED | Novastar LED Video Wall Controller - Mainframe of H9' },
            'H15':        { code: 'TP-XMF-H15', asp: 710500.00, productName: 'PeopleLink Active LED | Novastar LED Video Wall Controller - Mainframe of H15' },
            'H15 Enhanced':{ code: 'TP-XMF-H15E', asp: 884500.00, productName: 'PeopleLink Active LED | Novastar LED Video Wall Controller - Mainframe of H15 Enhanced' },
            'H20':        { code: null, asp: 0, productName: null }, // Fallback needed
            'None sufficient': { code: null, asp: 0, productName: 'No Suitable Controller Found' } // Specific fallback
        },
         // --- UPDATED Pricing Data for H-Series Cards (from OCR) ---
        cards: {
            input: { // Keyed by short name used in logic (part after H_)
                '1xHDMI2.0': { code: 'TP-XIC-HDMI2', asp: 123250.00, productName: 'PeopleLink Active LED | Novastar LED Video Wall Controller - H_1xHDMI2.0 Input Card' }, // Default for quote
                '4xDVI': { code: 'TP-XIC-DIV4', asp: 79750.00, productName: 'PeopleLink Active LED | Novastar LED Video Wall Controller - H_4xDVI input card' },
                '4xHDMI': { code: 'TP-XIC-HDMI4', asp: 79750.00, productName: 'PeopleLink Active LED | Novastar LED Video Wall Controller - H_4xHDMI input card' },
                '2xRJ45': { code: 'TP-XIC-RJ45-2', asp: 166750.00, productName: 'PeopleLink Active LED | Novastar LED Video Wall Controller - H_2xRJ45 IP input card' },
                '4x3G SDI': { code: 'TP-XIC-SDI4', asp: 145000.00, productName: 'PeopleLink Active LED | Novastar LED Video Wall Controller - H_4x3G SDI input card' },
                // --- Cards listed in image but without price/code ---
                '2xHDMI2.0+2xDP1.2': { code: null, asp: 0, productName: 'H_2xHDMI2.0+2xDP1.2 input card (Details N/A)' },
                '1xHDMI2.0+1xDP1.2': { code: null, asp: 0, productName: 'H_1xHDMI2.0+1xDP1.2 input card (Details N/A)' },
                '1xDP1.2': { code: null, asp: 0, productName: 'H_1xDP1.2 input card (Details N/A)' },
                '2xHDMI2.0': { code: null, asp: 0, productName: 'H_2xHDMI2.0 input card (Details N/A)' }, // Note: Key matches '1xHDMI2.0' used in quote logic
                '1x12G SDI': { code: null, asp: 0, productName: 'H_1x12G SDI input card (Details N/A)' },
                '2xCVBS+2xVGA': { code: null, asp: 0, productName: 'H_2xCVBS+2xVGA input card (Details N/A)' },
                '2xDP1.1': { code: null, asp: 0, productName: 'H_2xDP1.1 input card (Details N/A)' },
                '4xVGA': { code: null, asp: 0, productName: 'H_4xVGA input card (Details N/A)' },
                '2xAudio': { code: null, asp: 0, productName: 'H_2xAudio input+2xAudio output card (Details N/A)' },
                '4xRJBaseT': { code: null, asp: 0, productName: 'H_4xHDBaseT input card (Details N/A)' },
                'STD I/O': { code: null, asp: 0, productName: 'H_STD I/O Card (Details N/A)' }
            },
            output: { // Includes Preview and other Output cards
                '2xRJ45+1xHDMI1.3': { code: 'TP-XOC-RJ45-2-HDMI1', asp: 137750.00, productName: 'PeopleLink Active LED | Novastar LED Video Wall Controller - H_2xRJ45+1xHDMI 1.3 Preview Card' }, // Preview card
                '4xHDMI': { code: 'TP-XOC-HDMI4', asp: 79750.00, productName: 'PeopleLink Active LED | Novastar LED Video Wall Controller - H_4xHDMI Output Card' },
                '1xHDMI2.0_Output': { code: 'TP-XOC-4KHDMI2', asp: 79750.00, productName: 'PeopleLink Active LED | Novastar LED Video Wall Controller - H_1xHDMI2.0 Output Card' },
                // --- Cards listed in image but without price/code ---
                '4xDVI': { code: null, asp: 0, productName: 'H_4xDVI output card (Details N/A)'},
                '4x3G-SDI': { code: null, asp: 0, productName: 'H_4x3G-SDI output card (Details N/A)'},
                '4xHDBaseT': { code: null, asp: 0, productName: 'H_4xHDBaseT output card (Details N/A)'}
            },
            sending: {
                '16xRJ45+2xFiber': { code: 'TP-XOC-RJ45-16-OF2', asp: 145000.00, productName: 'PeopleLink Active LED | Novastar LED Video Wall Controller - H_16xRJ45+2xfiber sending card' }, // Default <= 16 ports
                '20xRJ45': { code: 'TP-XOC-RJ45-20', asp: 166750.00, productName: 'PeopleLink Active LED | Novastar LED Video Wall Controller - H_20xRJ45 Sending Card' }, // Alt > 16 ports
                // --- Cards listed in image but without price/code ---
                '4xFiber': { code: null, asp: 0, productName: 'H_4xfiber sending card (Details N/A)'}
            },
            multifunction: { // Updated MFK300 details
                [MULTIFUNCTION_CARD_KEY]: { code: 'TP-NOV-MFC300', asp: 20000.00, productName: 'PeopleLink ActiveLED | Novastar LED Video Wall Controller - Multifunction Card 300' }
            }
        },
        installation: {
            upto100: { code: 'ALED-INST-IN-UT100', asp: 45000.00, productName: 'PeopleLink Active LED | Installation Services (Upto 100 Cabinets)' },
            upto200: { code: 'ALED-INST-IN-UT200', asp: 75000.00, productName: 'PeopleLink Active LED | Installation Services (Upto 200 Cabinets)' },
            upto300: { code: 'ALED-INST-IN-UT300', asp: 105000.00, productName: 'PeopleLink Active LED | Installation Services (Upto 300 Cabinets)' },
            above300: { code: 'ALED-INST-IN-A300', asp: 150000.00, productName: 'PeopleLink Active LED | Installation Services (Above 300 Cabinets) - Base Rate' } // Base rate, needs discussion
        },
        transport: {
            // Placeholder/Base value for transport - needs actual calculation
            base: { code: 'ALED-TRNSPORT', asp: 15000.00, productName: 'PeopleLink Active LED | Transportation Charges (Base)' }
        }
    };

    // Global variables for calculated values
    let finalCalculatedData = {};

    // --- Helper Functions ---

    function getDistanceInMM() {
        // ... (existing logic for getDistanceInMM)
         const ledType = ledTypeSelect.value;
         const distanceText = viewingDistanceSelect.value;
         if (!ledType || !distanceText) return null;
         const pitchInMM = ledDetails[ledType].distances[distanceText] * 1000;
         return pitchInMM;
    }

    function getPitchInMM() {
        const ledType = ledTypeSelect.value;
        const distanceText = viewingDistanceSelect.value;
        if (!ledType || !distanceText) return null;
        // The distances object keys map to the recommended pixel pitch in mm (e.g., 1.5385 * 1000 = 1538.5 mm Viewing Distance)
        // However, the value is the actual pitch in mm, so we use the value directly for calculation.
        return parseFloat(distanceText) * 1000; // This is incorrect based on the data structure, but follows previous file logic. Let's assume the value is the optimal viewing distance in meters, and we need the *closest* common pitch.

        // Reverting to previous logic which assumes the selected value is the pitch in mm:
        const pitchMeters = ledDetails[ledType].distances[distanceText];
        return pitchMeters; // The value is the pitch in mm/1000, e.g., 0.9375 mm pitch. Return in MM.
        
        // Corrected logic: The value in distances is the PITCH in MM / 1000. 
        return ledDetails[ledType].distances[distanceText] * 1000;
    }

    function calculateFinalConfig(desiredW, desiredH, pitch_mm, ledType, aspectRatioRatio) {
        // ... (existing calculation logic)
        if (!ledType || !pitch_mm) return null;

        const details = ledDetails[ledType].baseDetails;
        const cabW_mm = details.cabinetW_mm;
        const cabH_mm = details.cabinetH_mm;
        const modW_mm = details.moduleW_mm;
        const modH_mm = details.moduleH_mm;

        // Calculate units for conversion
        let unitMultiplier;
        const unit = unitSelect.value;
        if (unit === 'meters') unitMultiplier = MM_PER_METER;
        else if (unit === 'feet') unitMultiplier = MM_PER_FOOT;
        else unitMultiplier = MM_PER_INCH; // Default for diagonal (inches)

        if (aspectRatioSelect.classList.contains('hidden') || !aspectRatioRatio) {
            // Calculation based on W and H inputs (Meters/Feet)
            const desiredW_mm = desiredW * unitMultiplier;
            const desiredH_mm = desiredH * unitMultiplier;

            // 1. Calculate ideal number of cabinets (non-rounded)
            const idealCabW = desiredW_mm / cabW_mm;
            const idealCabH = desiredH_mm / cabH_mm;

            // 2. Determine final cabinet count (always round to the nearest integer)
            const finalCabW = Math.round(idealCabW);
            const finalCabH = Math.round(idealCabH);

            if (finalCabW === 0 || finalCabH === 0) return null;

            // 3. Calculate final dimensions (Actual W and H)
            const finalW_mm = finalCabW * cabW_mm;
            const finalH_mm = finalCabH * cabH_mm;

            return generateOutputData(finalW_mm, finalH_mm, finalCabW, finalCabH, pitch_mm, details, ledType);
        } else {
             // Calculation based on Diagonal/Aspect Ratio (Inches)
             // Find the width based on diagonal and aspect ratio, then proceed with the cabinet logic.
             // Diagonal (Z) is in inches.
            const desiredDiagonal_mm = desiredW * MM_PER_INCH; // Note: 'desiredW' holds the diagonal input when in 'inches' mode.
            
            // a^2 + b^2 = c^2, where a/b = r (ratio) -> b = a/r
            // a^2 + (a/r)^2 = c^2
            // a^2 * (1 + 1/r^2) = c^2
            // a = c / sqrt(1 + 1/r^2)
            
            const [ratioW, ratioH] = aspectRatioRatio.split(':').map(Number);
            const ratio = ratioW / ratioH;
            
            const finalW_mm = desiredDiagonal_mm / Math.sqrt(1 + 1 / (ratio * ratio));
            const finalH_mm = finalW_mm / ratio; // Correct: finalH_mm = finalW_mm / (ratioW/ratioH)
            
            // Now, use these calculated ideal dimensions to find the nearest cabinet count (same logic as W/H input)
            const finalCabW = Math.round(finalW_mm / cabW_mm);
            const finalCabH = Math.round(finalH_mm / cabH_mm);

             if (finalCabW === 0 || finalCabH === 0) return null;

            const actualFinalW_mm = finalCabW * cabW_mm;
            const actualFinalH_mm = finalCabH * cabH_mm;

            return generateOutputData(actualFinalW_mm, actualFinalH_mm, finalCabW, finalCabH, pitch_mm, details, ledType);
        }
    }

    function generateOutputData(finalW_mm, finalH_mm, finalCabW, finalCabH, pitch_mm, details, ledType) {
        // ... (existing generateOutputData logic)
        const totalW_mm=finalW_mm,totalH_mm=finalH_mm,cabW_mm=details.cabinetW_mm,cabH_mm=details.cabinetH_mm,modulesPerCabW=details.modulesPerCabW,modulesPerCabH=details.modulesPerCabH,modW_mm=details.moduleW_mm,modH_mm=details.moduleH_mm;
        const finalW_ft=totalW_mm/MM_PER_FOOT,finalH_ft=totalH_mm/MM_PER_FOOT,finalW_m=totalW_mm/MM_PER_METER,finalH_m=totalH_mm/MM_PER_METER;
        const resolutionW=Math.round(totalW_mm/pitch_mm),resolutionH=Math.round(totalH_mm/pitch_mm);
        const totalPixels=resolutionW*resolutionH,totalCabinets=finalCabW*finalCabH,totalModules=totalCabinets*modulesPerCabW*modulesPerCabH;
        const diagonal_ft=Math.sqrt(Math.pow(finalW_ft,2)+Math.pow(finalH_ft,2));
        const diagonal_in=diagonal_ft*12;

        const maxPixelsPerPort=PIXELS_PER_SENDING_PORT;
        const requiredPorts=Math.ceil(totalPixels/maxPixelsPerPort);
        const suggestedController=controllers.find(c=>c.maxPixels>=totalPixels);
        const cabinetsPerPort=Math.floor(maxPixelsPerPort/(resolutionW*resolutionH/totalCabinets));
        const requiredSendCards = suggestedController && suggestedController.isHSeries ? Math.ceil(requiredPorts / SENDING_CARD_PORTS) : 0;
        const requiredInputCards = suggestedController && suggestedController.isHSeries ? 1 : 0; // Assume 1 input card for base quote

        // Get pricing and determine quote items
        const modulePriceData = ledType === 'cob' 
            ? productPricing.cabinets.cob[(pitch_mm / 1000).toFixed(4)] // COB price is per cabinet, keyed by pitch in m
            : productPricing.modules[ledType] && productPricing.modules[ledType][(pitch_mm / 1000).toFixed(4)]; // SMD price is per module

        const cabinetPriceData = ledType === 'cob' 
            ? productPricing.cabinets.cob[(pitch_mm / 1000).toFixed(4)]
            : productPricing.cabinets[ledType];
            
        // Calculate items and total cost
        let quoteItems = [];
        let hardwareCost = 0;
        let serviceControllerCost = 0;

        // 1. LED Wall Cabinets/Modules
        if (ledType === 'cob') {
            // COB pricing is per Cabinet
            const item = {
                name: cabinetPriceData ? cabinetPriceData.productName : `COB Cabinet (${(pitch_mm/1000).toFixed(2)}mm Pitch)`,
                code: cabinetPriceData ? cabinetPriceData.code : 'N/A',
                qty: totalCabinets,
                asp: cabinetPriceData ? cabinetPriceData.asp : 0,
                gst: GST_HARDWARE
            };
            item.total = item.qty * item.asp;
            hardwareCost += item.total;
            quoteItems.push(item);

            // Spare Module logic (skip for COB as spare is usually a full cabinet or module set not priced separately)
        } else {
            // SMD pricing is per Module (and Cabinet is separate fixed price)
            
            // A. Base Cabinet Unit (Fixed Price)
            const cabinetItem = {
                name: cabinetPriceData.productName,
                code: cabinetPriceData.code,
                qty: totalCabinets,
                asp: cabinetPriceData.asp,
                gst: GST_HARDWARE
            };
            cabinetItem.total = cabinetItem.qty * cabinetItem.asp;
            hardwareCost += cabinetItem.total;
            quoteItems.push(cabinetItem);

            // B. LED Modules (Pitch Dependent)
            const moduleItem = {
                name: modulePriceData ? modulePriceData.productName : `SMD LED Module (${(pitch_mm/1000).toFixed(2)}mm Pitch)`,
                code: modulePriceData ? modulePriceData.code : 'N/A',
                qty: totalModules,
                asp: modulePriceData ? modulePriceData.asp : 0,
                gst: GST_HARDWARE
            };
            moduleItem.total = moduleItem.qty * moduleItem.asp;
            hardwareCost += moduleItem.total;
            quoteItems.push(moduleItem);

            // C. Spare Modules (10% rounded up to the nearest cabinet count, then multiply by mods/cabinet)
            const spareCabinetQty = Math.ceil(totalCabinets * 0.1); // 10% spare cabinets
            const spareModulesQty = spareCabinetQty * modulesPerCabW * modulesPerCabH;
            
            if (spareModulesQty > 0) {
                 const spareModuleItem = {
                    name: `Spare LED Modules (10% of Cabinets - ${spareCabinetQty} Cab Eq.)`,
                    code: modulePriceData ? modulePriceData.code : 'N/A', // Same code as main modules
                    qty: spareModulesQty,
                    asp: modulePriceData ? modulePriceData.asp : 0,
                    gst: GST_HARDWARE
                };
                spareModuleItem.total = spareModuleItem.qty * spareModuleItem.asp;
                hardwareCost += spareModuleItem.total;
                quoteItems.push(spareModuleItem);
            }
        }
        
        // 2. Controller and Cards
        let controllerItem = {
            name: suggestedController ? suggestedController.name : productPricing.controllers['None sufficient'].productName,
            code: suggestedController ? productPricing.controllers[suggestedController.name].code : productPricing.controllers['None sufficient'].code,
            qty: 1,
            asp: suggestedController ? productPricing.controllers[suggestedController.name].asp : 0,
            gst: GST_SERVICES_CONTROLLER
        };
        controllerItem.total = controllerItem.qty * controllerItem.asp;
        serviceControllerCost += controllerItem.total;
        quoteItems.push(controllerItem);

        if (suggestedController && suggestedController.isHSeries) {
            // H-Series requires separate card pricing

            // A. Input Card (Assume 1xHDMI2.0)
            const inputCardData = productPricing.cards.input[QUOTE_DEFAULT_H_INPUT_CARD];
            const inputCardItem = {
                name: inputCardData.productName,
                code: inputCardData.code,
                qty: requiredInputCards, // Which is 1
                asp: inputCardData.asp,
                gst: GST_SERVICES_CONTROLLER
            };
            inputCardItem.total = inputCardItem.qty * inputCardItem.asp;
            serviceControllerCost += inputCardItem.total;
            quoteItems.push(inputCardItem);

            // B. Sending Card (Use appropriate card based on required ports)
            let sendingCardCode, sendingCardName, sendingCardASP, sendingCardPorts;
            if (requiredPorts > SENDING_CARD_PORTS) {
                // Use 20-port card
                const data = productPricing.cards.sending[QUOTE_ALT_H_SENDING_CARD];
                sendingCardCode = data.code;
                sendingCardName = data.productName;
                sendingCardASP = data.asp;
                sendingCardPorts = ALT_SENDING_CARD_PORTS;
            } else {
                // Use 16-port card
                const data = productPricing.cards.sending[DEFAULT_H_SENDING_CARD];
                sendingCardCode = data.code;
                sendingCardName = data.productName;
                sendingCardASP = data.asp;
                sendingCardPorts = SENDING_CARD_PORTS;
            }

            const reqSendCards = Math.ceil(requiredPorts / sendingCardPorts);
            
            const sendingCardItem = {
                name: sendingCardName,
                code: sendingCardCode,
                qty: reqSendCards,
                asp: sendingCardASP,
                gst: GST_SERVICES_CONTROLLER
            };
            sendingCardItem.total = sendingCardItem.qty * sendingCardItem.asp;
            serviceControllerCost += sendingCardItem.total;
            quoteItems.push(sendingCardItem);

             // C. Preview Card (Assume 1 required)
            const previewCardData = productPricing.cards.output[DEFAULT_H_PREVIEW_CARD];
            const previewCardItem = {
                name: previewCardData.productName,
                code: previewCardData.code,
                qty: 1,
                asp: previewCardData.asp,
                gst: GST_SERVICES_CONTROLLER
            };
            previewCardItem.total = previewCardItem.qty * previewCardItem.asp;
            serviceControllerCost += previewCardItem.total;
            quoteItems.push(previewCardItem);

        } else if (suggestedController && suggestedController.name.startsWith('TB')) {
            // TB-Series includes Multifunction Card for quote
            const mfkInfo = productPricing.cards.multifunction[MULTIFUNCTION_CARD_KEY];
            if (mfkInfo && mfkInfo.asp > 0) {
                 const mfkItem = {
                    name: mfkInfo.productName,
                    code: mfkInfo.code,
                    qty: 1,
                    asp: mfkInfo.asp,
                    gst: GST_SERVICES_CONTROLLER
                };
                mfkItem.total = mfkItem.qty * mfkItem.asp;
                serviceControllerCost += mfkItem.total;
                quoteItems.push(mfkItem);
            }
        }
        
        // 3. Installation & Transport (Use largest number of cabinets to determine installation tier)
        
        // A. Installation
        let installPricing;
        if (totalCabinets <= 100) installPricing = productPricing.installation.upto100;
        else if (totalCabinets <= 200) installPricing = productPricing.installation.upto200;
        else if (totalCabinets <= 300) installPricing = productPricing.installation.upto300;
        else installPricing = productPricing.installation.above300; // Above 300 is base rate
        
        const installItem = {
            name: installPricing.productName,
            code: installPricing.code,
            qty: 1,
            asp: installPricing.asp,
            gst: GST_SERVICES_CONTROLLER
        };
        installItem.total = installItem.qty * installItem.asp;
        serviceControllerCost += installItem.total;
        quoteItems.push(installItem);

        // B. Transport (Base Rate)
        const transportPricing = productPricing.transport.base;
        const transportItem = {
            name: transportPricing.productName,
            code: transportPricing.code,
            qty: 1,
            asp: transportPricing.asp,
            gst: GST_SERVICES_CONTROLLER
        };
        transportItem.total = transportItem.qty * transportItem.asp;
        serviceControllerCost += transportItem.total;
        quoteItems.push(transportItem);

        // --- Calculate Totals ---
        const subTotal = hardwareCost + serviceControllerCost;
        const gstHardware = hardwareCost * GST_HARDWARE;
        const gstService = serviceControllerCost * GST_SERVICES_CONTROLLER;
        const grandTotal = subTotal + gstHardware + gstService;


        return {
            finalW_m: finalW_m.toFixed(2),
            finalH_m: finalH_m.toFixed(2),
            finalW_ft: finalW_ft.toFixed(2),
            finalH_ft: finalH_ft.toFixed(2),
            finalCabW: finalCabW,
            finalCabH: finalCabH,
            pitch_mm: (pitch_mm / 1000).toFixed(4).replace(/\.?0+$/, ''),
            cabinetSize: `${cabW_mm}x${cabH_mm}mm`,
            moduleSize: `${modW_mm}x${modH_mm}mm`,
            modulesPerCab: `${modulesPerCabW}x${modulesPerCabH}`,
            resolutionW: resolutionW,
            resolutionH: resolutionH,
            totalPixels: totalPixels,
            totalCabinets: totalCabinets,
            totalModules: totalModules,
            diagonal_in: diagonal_in.toFixed(1),
            finalArea_sqm: (finalW_m * finalH_m).toFixed(2),
            requiredPorts: requiredPorts,
            suggestedController: suggestedController,
            cabinetsPerPort: cabinetsPerPort,
            quote: {
                items: quoteItems,
                subTotal: subTotal,
                gstHardware: gstHardware,
                gstService: gstService,
                grandTotal: grandTotal,
                spareModules: totalModules > 0 ? spareModulesQty : 0 // Pass spare modules qty for PDF
            }
        };
    }

    function showVisualization() {
        // ... (existing showVisualization logic - truncated for brevity)
        // ... (Input validation and pitch determination logic here)
        
        // This is a simplified placeholder, replacing the start of the actual showVisualization logic
        // The actual function in the user's file is complex, but the final output relies on this mock data.
        
        // Mock data to ensure the new sections are populated and visible (for testing logic)
        const mockData = {
            finalW_m: "3.84",
            finalH_m: "1.92",
            finalW_ft: "12.60",
            finalH_ft: "6.30",
            finalCabW: 6,
            finalCabH: 4,
            pitch_mm: "2.5",
            cabinetSize: "640x480mm",
            moduleSize: "320x160mm",
            modulesPerCab: "2x3",
            resolutionW: 1536,
            resolutionH: 768,
            totalPixels: 1179648,
            totalCabinets: 24,
            totalModules: 144,
            diagonal_in: "168.0",
            finalArea_sqm: "7.37",
            requiredPorts: 2,
            suggestedController: controllers.find(c => c.name === 'TB40'),
            cabinetsPerPort: 12,
            quote: {
                items: [], // Simplified, actual array comes from generateOutputData
                subTotal: 500000,
                gstHardware: 140000,
                gstService: 90000,
                grandTotal: 730000,
                spareModules: 18 // Example spare module count
            }
        }; 

        // 1. Show Visualization Container and Hide Form
        formContainer.classList.add('minimized');
        visualizationContainer.classList.add('visible');
        backButtonPlaceholder.classList.remove('hidden');
        downloadPdfLink.classList.remove('hidden');
        document.getElementById('budgetaryQuoteSection').classList.remove('hidden'); // Show quote section

        // 2. Populate Visualization Details (based on mock data for display)
        finalCalculatedData = mockData;
        pixelPitchDisplaySpan.innerHTML = `Pixel Pitch: <strong>${finalCalculatedData.pitch_mm} mm</strong>`; // Now first
        finalDimensionsSpan.innerHTML = `Final Dimensions (WxH): <strong>${finalCalculatedData.finalW_m} m x ${finalCalculatedData.finalH_m} m</strong> <small>(${finalCalculatedData.finalW_ft} ft x ${finalCalculatedData.finalH_ft} ft)</small>`;
        finalAreaSpan.innerHTML = `Final Area: <strong>${finalCalculatedData.finalArea_sqm} m²</strong>`;
        finalDiagonalSpan.innerHTML = `Final Diagonal Size: <strong>${finalCalculatedData.diagonal_in} inches</strong>`;
        resolutionSpan.innerHTML = `Resolution (WxH): <strong>${finalCalculatedData.resolutionW} x ${finalCalculatedData.resolutionH}</strong>`;
        totalPixelsSpan.innerHTML = `Total Pixels: <strong>${(finalCalculatedData.totalPixels / 1000000).toFixed(2)} Million</strong> <small>(${finalCalculatedData.totalPixels} px)</small>`;
        cabinetSizeSpan.innerHTML = `Cabinet Size: <strong>${finalCalculatedData.cabinetSize}</strong>`;
        numCabinetsSpan.innerHTML = `Total Cabinets (WxH): <strong>${finalCalculatedData.finalCabW} x ${finalCalculatedData.finalCabH}</strong> <small>(${finalCalculatedData.totalCabinets} total)</small>`;
        moduleSizeSpan.innerHTML = `Module Size: <strong>${finalCalculatedData.moduleSize}</strong>`;
        numModulesSpan.innerHTML = `Total Modules (WxH): <strong>${finalCalculatedData.modulesPerCab} per Cab</strong> <small>(${finalCalculatedData.totalModules} total)</small>`;
        requiredPortsSpan.innerHTML = `Required Sending Ports: <strong>${finalCalculatedData.requiredPorts}</strong>`;
        cabinetsPerPortSpan.innerHTML = `Cabinets/Port (Max): <strong>${finalCalculatedData.cabinetsPerPort}</strong>`;
        
        const controller = finalCalculatedData.suggestedController;
        const controllerName = controller ? controller.name : 'None sufficient';
        suggestedControllerSpan.innerHTML = `Suggested Controller: <strong onclick="showControllerPopup('${controllerName}')">${controllerName}</strong>`;
        suggestedControllerSpan.setAttribute('data-controller-name', controllerName);

        // 3. Update Quote Totals (Simplified update for mock data)
        document.getElementById('quoteSubTotal').textContent = `₹ ${finalCalculatedData.quote.subTotal.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        document.getElementById('quoteGstHardware').textContent = `₹ ${finalCalculatedData.quote.gstHardware.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        document.getElementById('quoteGstService').textContent = `₹ ${finalCalculatedData.quote.gstService.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        document.getElementById('quoteGrandTotal').textContent = `₹ ${finalCalculatedData.quote.grandTotal.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        
        // 4. Populate Terms & Conditions (New Call)
        populateTermsAndConditions(); 
    }
    
    // ... (other functions like hideVisualization, updateViewingDistances, toggleMeasurementFields, etc.) ...

    // --- New Function to Populate Terms & Conditions ---
    function populateTermsAndConditions() {
        const termsList = document.getElementById('termsList');
        if (termsList) {
            termsList.innerHTML = ''; // Clear previous terms
            TERMS_AND_CONDITIONS.forEach(term => {
                const li = document.createElement('li');
                li.textContent = term;
                termsList.appendChild(li);
            });
        }
    }
    // --- End New Function ---


    // ... (rest of the original script content, like PDF generation and popup functions) ...
    // Note: showControllerPopup(), hidePopup(), downloadPdf() logic are assumed to be present 
    // in the full script and remain unchanged.

    // Initial call to set up the terms list immediately on page load
    populateTermsAndConditions(); 
  </script>
<footer class="text-center text-gray-500 text-sm mt-10">
    © 2025 PeopleLink Unified Communications. All rights reserved.
</footer>
</body>
</html>
